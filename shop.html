<!-- æ–‡ä»¶å: shop.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº—èˆ—è©³ç´° - ç¥æˆ¸å¤–å›½äººç”Ÿæ´»ã‚¬ã‚¤ãƒ‰</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .shop-container {max-width:900px;margin:20px auto;padding:0 1em;}
    .shop-header {display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
    .shop-header img {width:280px;max-width:100%;border-radius:10px;object-fit:cover;}
    .shop-info {flex:1;}
    .shop-info h2{margin:0 0 10px;}
    .shop-field{margin:4px 0;font-size:15px;}
    .shop-field i{width:20px;color:#0a66c2;}
    .badge{display:inline-block;background:#eef;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px;}
    #comment-box{margin-top:30px;}
  </style>
</head>
<body>
  <header>
    <h1>ğŸª åº—èˆ—è©³ç´°</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main class="shop-container">
    <div id="shop-detail"><p>èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>

    <div id="comment-box">
      <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
      <form id="comment-form">
        <input type="text" id="username" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰"><br>
        <textarea id="usercomment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>
        <div id="rating-stars">
          <span class="star-input" data-value="1">â˜…</span>
          <span class="star-input" data-value="2">â˜…</span>
          <span class="star-input" data-value="3">â˜…</span>
          <span class="star-input" data-value="4">â˜…</span>
          <span class="star-input" data-value="5">â˜…</span>
        </div>
        <button type="submit">é€ä¿¡</button>
      </form>
      <div id="comments"></div>
      <button id="loadMore" style="display:none">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";
    const params=new URLSearchParams(location.search);
    const shopId=params.get("shop");
    let shopData=null,lastVisible=null,selectedRating=0;

    if(!shopId){
      document.getElementById("shop-detail").innerHTML="<p style='color:red;'>URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?shop= ã«åº—IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>";
    }else{
      Papa.parse(CSV_URL,{
        download:true,header:true,
        complete:({data})=>{
          shopData=data.find(r=>(r.id||r.name)===shopId||r.name===shopId);
          if(!shopData){
            document.getElementById("shop-detail").innerHTML="<p>è©²å½“ã™ã‚‹åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";return;
          }
          renderShop(shopData);
          loadComments(true);
        }
      });
    }

    function renderShop(d){
      const c=(x)=>x&&x.trim()?x.trim():"";
      const cats=(c(d.category)||"").split(",").map(s=>s.trim()).filter(Boolean);
      document.title=d.name+" - åº—èˆ—è©³ç´°";
      document.getElementById("shop-detail").innerHTML=`
        <div class="shop-header">
          ${c(d.image)?`<img src="${d.image}" alt="${d.name}">`:""}
          <div class="shop-info">
            <h2>${d.name}</h2>
            ${cats.length?cats.map(x=>`<span class="badge">${x}</span>`).join(" "):""}
            ${c(d.description)?`<p>${d.description}</p>`:""}
            ${c(d.address)?`<div class="shop-field"><i class="fa-solid fa-location-dot"></i>${d.address}</div>`:""}
            ${c(d.hours)?`<div class="shop-field"><i class="fa-regular fa-clock"></i>${d.hours}</div>`:""}
            ${c(d.phone)?`<div class="shop-field"><i class="fa-solid fa-phone"></i>${d.phone}</div>`:""}
            ${c(d.website)?`<div class="shop-field"><i class="fa-solid fa-link"></i><a href="${d.website}" target="_blank" rel="noopener">${d.website}</a></div>`:""}
            <div style="margin-top:10px;">
              <a class="btn" href="map.html?focus=${encodeURIComponent(d.id||d.name)}">ğŸ—º åœ°å›³ã§è¦‹ã‚‹</a>
            </div>
          </div>
        </div>`;
    }

    function loadComments(reset=false){
      const ref=db.collection("shops").doc(shopId).collection("comments").orderBy("time","desc").limit(5);
      let q=reset?ref:ref.startAfter(lastVisible);
      q.get().then(snap=>{
        const container=document.getElementById("comments");
        if(reset)container.innerHTML="";
        if(snap.empty){
          if(reset)container.innerHTML="<p class='muted'>ã‚³ãƒ¡ãƒ³ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
          document.getElementById("loadMore").style.display="none";return;
        }
        snap.forEach(doc=>{
          const d=doc.data();const t=d.time?.toDate?.()||new Date();
          const ts=`${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,"0")}`;
          const stars="â˜…".repeat(d.rating||0)+"â˜†".repeat(5-(d.rating||0));
          const div=document.createElement("div");
          div.className="comment";
          div.innerHTML=`<strong>${d.name||"åŒ¿å"}</strong> <small>ï¼ˆ${ts}ï¼‰</small><br><div class='stars'>${stars}</div>${d.text}`;
          container.appendChild(div);
        });
        lastVisible=snap.docs[snap.docs.length-1];
        document.getElementById("loadMore").style.display=snap.size<5?"none":"block";
      });
    }

    document.getElementById("loadMore").onclick=()=>loadComments();

    document.querySelectorAll(".star-input").forEach(star=>{
      star.addEventListener("click",()=>{
        selectedRating=parseInt(star.dataset.value);
        document.querySelectorAll(".star-input").forEach(s=>s.classList.remove("selected"));
        for(let i=1;i<=selectedRating;i++){
          document.querySelector(`.star-input[data-value='${i}']`).classList.add("selected");
        }
      });
    });

    document.getElementById("comment-form").addEventListener("submit",e=>{
      e.preventDefault();
      const name=document.getElementById("username").value.trim();
      const text=document.getElementById("usercomment").value.trim();
      if(!text)return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      db.collection("shops").doc(shopId).collection("comments").add({
        name:name||"åŒ¿å",
        text,
        rating:selectedRating,
        time:new Date()
      }).then(()=>{
        document.getElementById("usercomment").value="";
        document.getElementById("username").value="";
        selectedRating=0;
        document.querySelectorAll(".star-input").forEach(s=>s.classList.remove("selected"));
        alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚");
        loadComments(true);
      });
    });
  </script>
</body>
</html>
