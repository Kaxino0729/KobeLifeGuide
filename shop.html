<!-- æ–‡ä»¶å: shop.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>åº—èˆ—è©³ç´° - ç¥æˆ¸å¤–å›½äººç”Ÿæ´»ã‚¬ã‚¤ãƒ‰</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* æœ¬é¡µå°‘é‡è¡¥å……æ ·å¼ï¼ˆå…¶ä½™èµ° style.cssï¼‰ */
    .shop-hero{display:grid;grid-template-columns:180px 1fr;gap:14px;align-items:start}
    .shop-hero img{width:100%;border-radius:10px;object-fit:cover;max-height:180px}
    .shop-meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .badge{padding:2px 8px;border-radius:999px;background:#eef;font-size:12px}
    .muted{color:#64748b;font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .section{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:12px;margin-top:14px}
    .stars{color:#ffc107}
    .star-input{font-size:20px;color:#ccc;cursor:pointer}
    .star-input.selected{color:#ffc107}
    .comment{border-top:1px solid #eee;background:#f8faff;margin-bottom:6px;padding:8px;border-radius:4px}
    .btn-submit{background:#0a66c2;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    @media (max-width:640px){.shop-hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ· åº—èˆ—è©³ç´°</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2 id="shopTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
      <p class="muted" id="subtitle">URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?shop= ã«åº—IDã¾ãŸã¯åº—åã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>
    </section>

    <!-- åº—é“ºæ¦‚è¦ -->
    <section class="section" id="heroSection" style="display:none;">
      <div class="shop-hero">
        <img id="shopImage" alt="ç”»åƒ" src="" onerror="this.style.display='none'"/>
        <div>
          <div id="shopDesc"></div>
          <div class="shop-meta" id="shopMeta"></div>
          <div class="actions" id="shopActions"></div>
        </div>
      </div>
    </section>

    <!-- è¯¦æƒ…ä¿¡æ¯ï¼ˆå¯æ‹“å±•å­—æ®µï¼‰ -->
    <section class="section" id="detailSection" style="display:none;">
      <h3>ğŸ“Œ è©³ç´°æƒ…å ±</h3>
      <div id="detailContent"></div>
    </section>

    <!-- è¯„åˆ†æ¦‚è§ˆ -->
    <section class="section" id="ratingSummary" style="display:none;">
      <h3>â­ è©•ä¾¡ã®æ¦‚è¦</h3>
      <div id="avgRating">é›†è¨ˆä¸­â€¦</div>
    </section>

    <!-- è¯„è®ºæäº¤ -->
    <section class="section" id="commentWrite" style="display:none;">
      <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿</h3>
      <form id="commentForm">
        <input id="username" type="text" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰" />
        <textarea id="usercomment" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
        <div id="rating-stars" style="margin:6px 0;">
          <span class="star-input" data-value="1">â˜…</span>
          <span class="star-input" data-value="2">â˜…</span>
          <span class="star-input" data-value="3">â˜…</span>
          <span class="star-input" data-value="4">â˜…</span>
          <span class="star-input" data-value="5">â˜…</span>
        </div>
        <button type="submit" class="btn-submit">é€ä¿¡</button>
      </form>
    </section>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <section class="section" id="commentListSec" style="display:none;">
      <h3>ğŸ—‚ ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
      <div id="comments"></div>
      <div style="margin-top:8px;">
        <button id="loadMore" class="btn-submit" style="display:none;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </section>

    <!-- æœªæ‰¾åˆ° -->
    <section class="section" id="notFound" style="display:none;">
      <p>è©²å½“ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
      <div class="actions">
        <a class="btn" href="search.html">ğŸ” æ¤œç´¢ã«æˆ»ã‚‹</a>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    /* ====== å…¨å±€çŠ¶æ€ & å·¥å…· ====== */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";
    const q = (k) => new URLSearchParams(location.search).get(k);
    const SHOP_PARAM = (q("shop") || "").trim();

    const ROLE  = localStorage.getItem("auth_role") || "user";
    const EMAIL = localStorage.getItem("auth_email") || null;
    const UID   = localStorage.getItem("auth_uid") || null;

    let currentShop = null;   // CSV è¡Œï¼ˆåŸºç¡€ä¿¡æ¯ï¼‰
    let shopId = null;        // ç¨³å®š ID
    let lastVisible = null;   // è¯„è®ºåˆ†é¡µæ¸¸æ ‡
    let selectedRating = 0;

    /* ====== Firebase åˆå§‹åŒ– ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ====== ç™»å½•çŠ¶æ€æ¡ & ç®¡ç†å¯è§æ€§ ====== */
    (function () {
      if (EMAIL) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center";
        bar.style.padding = "6px";
        bar.style.background = "#f0f4f8";
        bar.style.color = "#333";
        bar.style.fontSize = "14px";
        bar.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${EMAIL}ï¼ˆå½¹å‰²: ${ROLE || "user"}ï¼‰`;
        document.body.prepend(bar);
      }
      if (ROLE !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    /* ====== è¯»å– CSVï¼Œå®šä½åº—é“º ====== */
    if (!SHOP_PARAM) {
      document.getElementById("notFound").style.display = "block";
      document.getElementById("subtitle").textContent = "URLã« ?shop= ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚";
    } else {
      document.getElementById("subtitle").textContent = `åº—èˆ—ã‚­ãƒ¼: ${SHOP_PARAM}`;
      Papa.parse(CSV_URL, {
        download: true, header: true,
        complete: ({ data }) => {
          // å…ˆç”¨ id ç²¾ç¡®åŒ¹é…ï¼Œæ‰¾ä¸åˆ°å†ç”¨ name åŒ¹é…
          let byId = data.find(r => (r.id || "").trim() === SHOP_PARAM);
          let byName = data.find(r => !byId && (r.name || "").trim() === SHOP_PARAM);
          currentShop = byId || byName || null;

          if (!currentShop) {
            document.getElementById("notFound").style.display = "block";
            document.getElementById("shopTitle").textContent = "åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            return;
          }
          shopId = (currentShop.id && currentShop.id.trim()) || (currentShop.name || "");

          // æ¸²æŸ“åŸºç¡€ä¿¡æ¯
          renderBase(currentShop);

          // å¯é€‰ï¼šè¯»å– Firestore shops/{id} çš„ meta è¦†ç›–/è¡¥å……
          db.collection("shops").doc(shopId).get()
            .then(doc => {
              const meta = doc.exists ? (doc.data().meta || null) : null;
              if (meta) applyMeta(meta);
            })
            .catch(() => {/* å¿½ç•¥ */})
            .finally(() => {
              // æ˜¾ç¤ºè¯„è®ºåŒºåŸŸ
              document.getElementById("commentWrite").style.display = "block";
              document.getElementById("commentListSec").style.display = "block";
              // è½½å…¥è¯„è®º & æ¦‚è§ˆ
              loadComments(true);
              calcAvgRating();
            });
        }
      });
    }

    /* ====== æ¸²æŸ“åŸºç¡€ä¿¡æ¯ï¼ˆæ¥è‡ª CSVï¼‰ ====== */
    function renderBase(row) {
      const title = row.name || "(ç„¡å)";
      const desc  = row.description || "";
      const img   = row.image || "";
      const link  = row.link || "";
      const cat   = (row.category || "").trim();
      const lat   = row.lat ? parseFloat(row.lat) : null;
      const lng   = row.lng ? parseFloat(row.lng) : null;

      document.getElementById("shopTitle").textContent = title;
      document.getElementById("subtitle").textContent = cat ? `ã‚«ãƒ†ã‚´ãƒª: ${cat}` : "";

      const hero = document.getElementById("heroSection");
      hero.style.display = "block";
      const imgEl = document.getElementById("shopImage");
      if (img) imgEl.src = img;

      document.getElementById("shopDesc").innerHTML = desc ? `<p>${desc}</p>` : "";

      const metaEl = document.getElementById("shopMeta");
      metaEl.innerHTML = "";
      if (cat) {
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = cat;
        metaEl.appendChild(badge);
      }
      if (lat && lng) {
        const ll = document.createElement("span");
        ll.className = "muted";
        ll.textContent = `ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        metaEl.appendChild(ll);
      }

      const actions = document.getElementById("shopActions");
      actions.innerHTML = `
        ${link ? `<a class="info-link" href="${link}" target="_blank">â–¶ è©³ã—ãè¦‹ã‚‹</a>` : ""}
        <a class="btn" href="map.html?focus=${encodeURIComponent(shopId)}">ğŸ—º åœ°å›³ã§è¦‹ã‚‹</a>
        <a class="btn" href="search.html">ğŸ” æ¤œç´¢ã«æˆ»ã‚‹</a>
        ${lat && lng ? `<a class="btn" href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">ğŸ“ Googleãƒãƒƒãƒ—</a>` : ""}
      `;
    }

    /* ====== åº”ç”¨ Firestore meta è¦†ç›–/è¡¥å……ï¼ˆå¯é€‰ï¼‰ ====== */
    function applyMeta(meta) {
      // ä½ å¯ä»¥åœ¨ shops/{id} æ–‡æ¡£é‡Œæ”¾ meta: { address, hours, photos:[], services:[], notes, ... }
      // è¿™é‡ŒæŒ‰å­˜åœ¨å³æ˜¾ç¤ºçš„åŸåˆ™æ¸²æŸ“
      const box = document.getElementById("detailSection");
      const content = document.getElementById("detailContent");
      let html = "";

      if (meta.address) html += `<p><strong>ä½æ‰€:</strong> ${meta.address}</p>`;
      if (meta.hours)   html += `<p><strong>å–¶æ¥­æ™‚é–“:</strong> ${meta.hours}</p>`;
      if (Array.isArray(meta.services) && meta.services.length) {
        html += `<p><strong>ã‚µãƒ¼ãƒ“ã‚¹:</strong> ${meta.services.join(" / ")}</p>`;
      }
      if (meta.tel)     html += `<p><strong>é›»è©±:</strong> ${meta.tel}</p>`;
      if (meta.notes)   html += `<p><strong>å‚™è€ƒ:</strong> ${meta.notes}</p>`;

      if (Array.isArray(meta.photos) && meta.photos.length) {
        html += `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">` +
                meta.photos.map(u => `<img src="${u}" alt="photo" style="width:120px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eee">`).join("") +
                `</div>`;
      }

      if (html) {
        content.innerHTML = html;
        box.style.display = "block";
      }
    }

    /* ====== è¯„è®ºï¼šåŠ è½½ï¼ˆåˆ†é¡µï¼‰ ====== */
    function loadComments(reset=false) {
      if (!shopId) return;
      const listEl = document.getElementById("comments");
      const moreBtn = document.getElementById("loadMore");
      document.getElementById("ratingSummary").style.display = "block";

      if (reset) { listEl.innerHTML=""; lastVisible=null; }

      let ref = db.collection("shops").doc(shopId).collection("comments")
                  .orderBy("time","desc").limit(5);
      if (lastVisible) ref = ref.startAfter(lastVisible);

      ref.get().then(snap => {
        if (snap.empty) {
          moreBtn.style.display = "none";
          if (reset) listEl.innerHTML = "<small>ã‚³ãƒ¡ãƒ³ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</small>";
          return;
        }
        snap.forEach(doc => {
          const d = doc.data();
          const id = doc.id;
          const t = d.time?.toDate ? d.time.toDate() : new Date();
          const timeStr = `${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}`;
          const stars = "â˜…".repeat(d.rating || 0) + "â˜†".repeat(5 - (d.rating || 0));
          const row = document.createElement("div");
          row.className = "comment";
          row.innerHTML = `
            <strong>${d.name || "åŒ¿å"}</strong> <span class="stars">${stars}</span><br/>
            ${d.text ? `<div>${d.text}</div>` : ""}
            <small class="muted">${timeStr}${d.email ? ` ãƒ» ${d.email}` : ""}</small>
            ${ROLE === "admin" ? `
              <div style="margin-top:6px;">
                <button class="btn-submit admin-only" data-action="edit" data-id="${id}" style="padding:6px 10px;">ç·¨é›†</button>
                <button class="btn-submit admin-only" data-action="del"  data-id="${id}" style="padding:6px 10px;background:#a30000;">å‰Šé™¤</button>
              </div>
            ` : ""}
          `;
          listEl.appendChild(row);
        });
        lastVisible = snap.docs[snap.docs.length - 1];
        moreBtn.style.display = snap.size < 5 ? "none" : "block";
      });
    }
    document.getElementById("loadMore").addEventListener("click", () => loadComments(false));

    /* ====== è¯„åˆ†æ¦‚è§ˆï¼ˆå¹³å‡åˆ† + è®¡æ•°ï¼‰ ====== */
    function calcAvgRating() {
      if (!shopId) return;
      const out = document.getElementById("avgRating");
      db.collection("shops").doc(shopId).collection("comments").get().then(snap => {
        if (snap.empty) { out.textContent = "ã¾ã è©•ä¾¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
        let sum=0, n=0;
        snap.forEach(doc => { const r = doc.data().rating||0; sum+=r; n++; });
        const avg = (sum/n).toFixed(2);
        out.innerHTML = `å¹³å‡è©•ä¾¡: <strong>${avg}</strong> / 5 ï¼ˆ${n} ä»¶ï¼‰`;
      }).catch(()=>{ out.textContent = "é›†è¨ˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"; });
    }

    /* ====== æäº¤è¯„è®ºï¼ˆå« uid/emailï¼Œæ»¡è¶³è§„åˆ™ï¼‰ ====== */
    document.getElementById("commentForm").addEventListener("submit", e => {
      e.preventDefault();
      if (!shopId) return;

      const name = (document.getElementById("username").value || "").trim() || "åŒ¿å";
      const text = (document.getElementById("usercomment").value || "").trim();
      if (!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      db.collection("shops").doc(shopId).collection("comments").add({
        uid: UID || null,
        email: EMAIL || null,
        name, text,
        rating: selectedRating || 0,
        time: new Date()
      }).then(() => {
        document.getElementById("username").value = "";
        document.getElementById("usercomment").value = "";
        selectedRating = 0;
        document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));
        alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚");
        loadComments(true);
        calcAvgRating();
      }).catch(err => {
        console.error(err);
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    });

    /* ====== æ˜Ÿçº§è¯„åˆ†äº¤äº’ ====== */
    document.querySelectorAll(".star-input").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = parseInt(star.dataset.value, 10);
        document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));
        for (let i=1;i<=selectedRating;i++){
          const node=document.querySelector(`.star-input[data-value='${i}']`);
          if (node) node.classList.add("selected");
        }
      });
    });

    /* ====== ç®¡ç†å‘˜ï¼šç¼–è¾‘ / åˆ é™¤ ====== */
    document.getElementById("comments").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      if (ROLE !== "admin") return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const ref = db.collection("shops").doc(shopId).collection("comments").doc(id);

      if (action === "del") {
        if (!confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try { await ref.delete(); alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚"); loadComments(true); calcAvgRating(); }
        catch (err){ console.error(err); alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
      } else if (action === "edit") {
        try {
          const snap = await ref.get();
          if (!snap.exists) return alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          const d = snap.data();
          const newText = prompt("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†ã—ã¦ãã ã•ã„ï¼š", d.text || "");
          if (newText === null) return;
          let newRating = d.rating || 0;
          const inputRating = prompt("è©•ä¾¡ï¼ˆ1ã€œ5ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š", String(newRating));
          if (inputRating !== null) {
            const r = parseInt(inputRating, 10);
            if (!isNaN(r) && r >= 1 && r <= 5) newRating = r;
          }
          await ref.update({ text: (newText||"").trim(), rating: newRating });
          alert("æ›´æ–°ã—ã¾ã—ãŸã€‚");
          loadComments(true); calcAvgRating();
        } catch (err){ console.error(err); alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
      }
    });
  </script>
</body>
</html>