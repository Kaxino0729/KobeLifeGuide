<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åº—èˆ—æƒ…å ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body>
<header>
  <h1>ğŸª åº—èˆ—æƒ…å ±</h1>
  <nav class="navbar">
    <a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
    <a href="map.html">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
    <a href="search.html">ğŸ” æ¤œç´¢</a>
    <a href="procedure.html">ğŸ“„ æ‰‹ç¶šã</a>
    <a href="review.html">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
    <a href="profile.html">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
    <a href="login.html">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
    <a href="admin.html" class="admin-only">ğŸ›  ç®¡ç†</a>
  </nav>
</header>

<main>
  <section id="shop-detail">
    <h2 id="shop-name">åº—èˆ—å</h2>
    <p id="shop-category"></p>
    <p id="shop-description"></p>
    <p id="shop-address"></p>
    <p id="shop-hours"></p>
    <p id="shop-phone"></p>
    <p><a id="shop-website" href="#" target="_blank"></a></p>
    <img id="shop-image" src="" alt="" style="max-width:100%;display:none;">
  </section>

  <section id="comments">
    <h3>ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
    <div id="comment-list"></div>

    <div id="comment-form">
      <textarea id="comment-text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
      <button id="submit-comment">é€ä¿¡</button>
    </div>
  </section>
</main>

<script>
  /* ===== Firebase config ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
    authDomain: "kobe-life-guide.firebaseapp.com",
    projectId: "kobe-life-guide",
    storageBucket: "kobe-life-guide.firebasestorage.app",
    messagingSenderId: "440390213094",
    appId: "1:440390213094:web:508d4e03409ca338b54a27"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* ===== auth info ===== */
  const UID = localStorage.getItem("auth_uid");
  const EMAIL = localStorage.getItem("auth_email");
  const ROLE = localStorage.getItem("auth_role") || "user";

  if (ROLE !== "admin") {
    document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
  }

  /* ===== URL param ===== */
  const params = new URLSearchParams(location.search);
  const shopId = params.get("shop");

  /* ===== CSV ===== */
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?output=csv";

  function loadShop() {
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        const shops = res.data;
        const shop = shops.find(s => s.id === shopId);
        if (!shop) {
          alert("åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          return;
        }

        document.getElementById("shop-name").textContent = shop.name || "";
        document.getElementById("shop-category").textContent = shop.category || "";
        document.getElementById("shop-description").textContent = shop.description || "";
        document.getElementById("shop-address").textContent = shop.address || "";
        document.getElementById("shop-hours").textContent = shop.hours || "";
        document.getElementById("shop-phone").textContent = shop.phone || "";

        if (shop.website) {
          const a = document.getElementById("shop-website");
          a.href = shop.website;
          a.textContent = shop.website;
        }

        if (shop.image) {
          const img = document.getElementById("shop-image");
          img.src = shop.image;
          img.style.display = "block";
        }

        loadComments();
      }
    });
  }

  /* ===== Comments ===== */
  function loadComments() {
    db.collection("shop_comments")
      .where("shopId", "==", shopId)
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        const list = document.getElementById("comment-list");
        list.innerHTML = "";
        snapshot.forEach(doc => {
          const c = doc.data();
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `
            <p>${c.text}</p>
            <small>${c.email || "åŒ¿å"}</small>
          `;
          list.appendChild(div);
        });
      });
  }

  document.getElementById("submit-comment").onclick = async () => {
    const text = document.getElementById("comment-text").value.trim();
    if (!text) return;

    if (!UID) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      return;
    }

    await db.collection("shop_comments").add({
      shopId,
      text,
      uid: UID,
      email: EMAIL,
      createdAt: new Date()
    });

    document.getElementById("comment-text").value = "";
  };

  loadShop();
</script>

<!-- ç™»å½•æ‹¦æˆª -->
<script src="auth-guard.js"></script>

<!-- admin-only ç»Ÿä¸€å¤„ç† -->
<script src="auth-util.js"></script>
<script>
  AuthUtil.refreshRoleAndApplyAdminUI();
</script>

</body>
</html>
