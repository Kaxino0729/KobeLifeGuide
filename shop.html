<!-- 文件名: shop.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>店舗詳細 - 神戸外国人生活ガイド</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .shop-hero{display:grid;grid-template-columns:180px 1fr;gap:14px;align-items:start}
    .shop-hero img{width:100%;border-radius:10px;object-fit:cover;max-height:180px}
    .shop-meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .badge{padding:2px 8px;border-radius:999px;background:#eef;font-size:12px}
    .muted{color:#64748b;font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .section{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:12px;margin-top:14px}
    .stars{color:#ffc107}
    .star-input{font-size:20px;color:#ccc;cursor:pointer}
    .star-input.selected{color:#ffc107}
    .comment{border-top:1px solid #eee;background:#f8faff;margin-bottom:6px;padding:8px;border-radius:4px}
    .btn-submit{background:#0a66c2;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    @media (max-width:640px){.shop-hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>🏷 店舗詳細</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">🏠 ホーム</a>
      <a href="procedure.html" class="btn">📄 手続きガイド</a>
      <a href="map.html" class="btn">🗺️ マップ</a>
      <a href="review.html" class="btn">⭐ レビュー</a>
      <a href="search.html" class="btn">🔎 検索</a>
      <a href="login.html" class="btn">🔐 ログイン</a>
      <a href="admin.html" class="btn admin-only">🛠 管理</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2 id="shopTitle">読み込み中…</h2>
      <p class="muted" id="subtitle">URLパラメータ ?shop= に店IDを指定してください。</p>
    </section>

    <section class="section" id="heroSection" style="display:none;">
      <div class="shop-hero">
        <img id="shopImage" alt="画像" src="" onerror="this.style.display='none'"/>
        <div>
          <div id="shopDesc"></div>
          <div class="shop-meta" id="shopMeta"></div>
          <div class="actions" id="shopActions"></div>
        </div>
      </div>
    </section>

    <section class="section" id="detailSection" style="display:none;">
      <h3>📌 詳細情報</h3>
      <div id="detailContent"></div>
    </section>

    <section class="section" id="ratingSummary" style="display:none;">
      <h3>⭐ 評価の概要</h3>
      <div id="avgRating">集計中…</div>
    </section>

    <section class="section" id="commentWrite" style="display:none;">
      <h3>💬 コメントを書く</h3>

      <form id="commentForm">
        <input type="text" id="username" placeholder="お名前（任意）" /><br/>
        <textarea id="usercomment" rows="3" placeholder="コメントを入力"></textarea><br/>

        <div id="rating-stars">
          <span class="star-input" data-value="1">★</span>
          <span class="star-input" data-value="2">★</span>
          <span class="star-input" data-value="3">★</span>
          <span class="star-input" data-value="4">★</span>
          <span class="star-input" data-value="5">★</span>
        </div>

        <button type="submit" class="btn-submit">送信</button>
      </form>
    </section>

    <section class="section" id="commentListSec" style="display:none;">
      <h3>🗂 コメント一覧</h3>
      <div id="comments"></div>
      <button id="loadMore" class="btn-submit" style="display:none;margin-top:6px;">もっと見る</button>
    </section>

    <section class="section" id="notFound" style="display:none;">
      <p>該当店舗が見つかりません。</p>
      <a class="btn" href="search.html">🔎 検索へ戻る</a>
    </section>
  </main>

  <footer><p>&copy; 2025 神戸外国人支援プロジェクト</p></footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    /* ✅ 已新增昵称本地变量 */
    const PROFILE_NAME = localStorage.getItem("profile_displayName") || null;
    const ROLE  = localStorage.getItem("auth_role") || "user";
    const EMAIL = localStorage.getItem("auth_email") || null;
    const UID   = localStorage.getItem("auth_uid") || null;

    /* 登录状态条 */
    (function () {
      if (EMAIL) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center";
        bar.style.padding = "6px";
        bar.style.background = "#f0f4f8";
        bar.style.color = "#333";
        bar.style.fontSize = "14px";
        bar.textContent = `ログイン中: ${EMAIL}（役割: ${ROLE}）`;
        document.body.prepend(bar);
      }
      if (ROLE !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    // Firebase 初始化
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";
    const p = new URLSearchParams(location.search);
    const key = (p.get("shop") || "").trim();
    let shopId=null,lastVisible=null,selectedRating=0;

    if(!key){
      document.getElementById("notFound").style.display="block";
    }else{
      Papa.parse(CSV,{
        download:true,header:true,
        complete:({data})=>{
          let row=data.find(r=>(r.id||"").trim()===key)||data.find(r=>!row&&(r.name||"").trim()===key);
          if(!row){document.getElementById("notFound").style.display="block";return;}
          shopId=(row.id||row.name).trim();
          renderBase(row);
          document.getElementById("commentWrite").style.display="block";
          document.getElementById("commentListSec").style.display="block";
          loadComments(true);
          calcAvgRating();
        }
      });
    }

    function renderBase(r){
      document.getElementById("shopTitle").textContent=r.name||"店名";
      document.getElementById("heroSection").style.display="block";
      const img=document.getElementById("shopImage");
      if(r.image) img.src=r.image;
      document.getElementById("shopDesc").innerHTML=r.description?`<p>${r.description}</p>`:"";
      const meta=document.getElementById("shopMeta");
      meta.innerHTML="";
      const cat=(r.category||"").trim();
      if(cat){
        const s=document.createElement("span");
        s.className="badge";s.textContent=cat;meta.append(s);
      }
      const actions=document.getElementById("shopActions");
      actions.innerHTML=`
        <a class="btn" href="map.html?focus=${encodeURIComponent(shopId)}">🗺 地図で見る</a>
        <a class="btn" href="search.html">🔎 検索に戻る</a>
      `;
    }

    /* 评论加载 */
    function loadComments(reset=false){
      if(!shopId)return;
      const list=document.getElementById("comments");
      const more=document.getElementById("loadMore");
      if(reset){list.innerHTML="";lastVisible=null;}

      let ref=db.collection("shops").doc(shopId).collection("comments").orderBy("time","desc").limit(5);
      if(lastVisible)ref=ref.startAfter(lastVisible);

      ref.get().then(snap=>{
        if(snap.empty){
          more.style.display="none";
          if(reset) list.innerHTML="<small>コメントがありません</small>";
          return;
        }
        snap.forEach(doc=>{
          const d=doc.data();
          const time=new Date(d.time.seconds*1000);
          const stars="★".repeat(d.rating||0)+"☆".repeat(5-(d.rating||0));
          const row=document.createElement("div");
          row.className="comment";
          row.innerHTML=`
            <strong>${d.name||"匿名"}</strong> <span class="stars">${stars}</span><br/>
            ${d.text}<br/>
            <small>${time.toLocaleString()}</small>
          `;
          list.append(row);
        });
        lastVisible=snap.docs[snap.docs.length-1];
        more.style.display=snap.size<5?"none":"block";
      });
    }
    document.getElementById("loadMore").onclick=()=>loadComments();

    /* ✅ 提交评论（优先使用昵称） */
    document.getElementById("commentForm").addEventListener("submit",e=>{
      e.preventDefault();
      const typed=(document.getElementById("username").value||"").trim();
      const name=(PROFILE_NAME&&PROFILE_NAME.trim())?PROFILE_NAME.trim():(typed||"匿名");
      const text=(document.getElementById("usercomment").value||"").trim();
      if(!text)return alert("コメントを入力してください。");

      db.collection("shops").doc(shopId).collection("comments").add({
        name,text,rating:selectedRating||0,
        uid:UID||null,email:EMAIL||null,
        time:new Date()
      }).then(()=>{
        document.getElementById("usercomment").value="";
        selectedRating=0;
        document.querySelectorAll(".star-input").forEach(x=>x.classList.remove("selected"));
        alert("送信しました！");
        loadComments(true);
        calcAvgRating();
      });
    });

    /* ✅ 有昵称自动填入并隐藏输入框 */
    if(PROFILE_NAME){
      const nm=document.getElementById("username");
      nm.value=PROFILE_NAME;
      nm.parentElement.style.display="none";
    }

    /* 星级评分 */
    document.querySelectorAll(".star-input").forEach(s=>{
      s.addEventListener("click",()=>{
        selectedRating=parseInt(s.dataset.value);
        document.querySelectorAll(".star-input").forEach(n=>n.classList.remove("selected"));
        for(let i=1;i<=selectedRating;i++)
          document.querySelector(`.star-input[data-value='${i}']`).classList.add("selected");
      });
    });

    /* 平均评价 */
    function calcAvgRating(){
      if(!shopId)return;
      db.collection("shops").doc(shopId).collection("comments").get().then(snap=>{
        if(snap.empty)return;
        let sum=0;
        snap.forEach(doc=>sum+=(doc.data().rating||0));
        const avg=(sum/snap.size).toFixed(2);
        document.getElementById("ratingSummary").style.display="block";
        document.getElementById("avgRating").innerHTML=`平均評価: <strong>${avg}</strong> / 5（${snap.size}件）`;
      });
    }
  </script>
</body>
</html>