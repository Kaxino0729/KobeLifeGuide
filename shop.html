<!-- æ–‡ä»¶å: shop.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>åº—èˆ—è©³ç´° - ç¥æˆ¸å¤–å›½äººç”Ÿæ´»ã‚¬ã‚¤ãƒ‰</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .shop-hero{display:grid;grid-template-columns:180px 1fr;gap:14px;align-items:start}
    .shop-hero img{width:100%;border-radius:10px;object-fit:cover;max-height:180px}
    .shop-meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .badge{padding:2px 8px;border-radius:999px;background:#eef;font-size:12px}
    .badge-medical{background:#ffe4e6}
    .muted{color:#64748b;font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .section{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:12px;margin-top:14px}
    .stars{color:#ffc107}
    .star-input{font-size:20px;color:#ccc;cursor:pointer}
    .star-input.selected{color:#ffc107}
    .comment{border-top:1px solid #eee;background:#f8faff;margin-bottom:6px;padding:8px;border-radius:4px}
    .btn-submit{background:#0a66c2;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    @media (max-width:640px){.shop-hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ· åº—èˆ—è©³ç´°</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2 id="shopTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
      <p class="muted" id="subtitle">URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?shop= ã«åº—IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</p>
    </section>

    <section class="section" id="heroSection" style="display:none;">
      <div class="shop-hero">
        <img id="shopImage" alt="ç”»åƒ" src="" onerror="this.style.display='none'"/>
        <div>
          <div id="shopDesc"></div>
          <div class="shop-meta" id="shopMeta"></div>
          <div class="actions" id="shopActions"></div>
        </div>
      </div>
    </section>

    <!-- è©³ç´°æƒ…å ± -->
    <section class="section" id="detailSection" style="display:none;">
      <h3>ğŸ“Œ è©³ç´°æƒ…å ±</h3>
      <div id="detailContent"></div>
      <div id="extraInfo" class="muted" style="margin-top:8px;"></div>
    </section>

    <section class="section" id="ratingSummary" style="display:none;">
      <h3>â­ è©•ä¾¡ã®æ¦‚è¦</h3>
      <div id="avgRating">é›†è¨ˆä¸­â€¦</div>
    </section>

    <section class="section" id="commentWrite" style="display:none;">
      <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã</h3>
      <form id="commentForm">
        <input type="text" id="username" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰" /><br/>
        <textarea id="usercomment" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br/>
        <div id="rating-stars">
          <span class="star-input" data-value="1">â˜…</span>
          <span class="star-input" data-value="2">â˜…</span>
          <span class="star-input" data-value="3">â˜…</span>
          <span class="star-input" data-value="4">â˜…</span>
          <span class="star-input" data-value="5">â˜…</span>
        </div>
        <button type="submit" class="btn-submit">é€ä¿¡</button>
      </form>
    </section>

    <section class="section" id="commentListSec" style="display:none;">
      <h3>ğŸ—‚ ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
      <div id="comments"></div>
      <button id="loadMore" class="btn-submit" style="display:none;margin-top:6px;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </section>

    <section class="section" id="notFound" style="display:none;">
      <p>è©²å½“åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>
      <a class="btn" href="search.html">ğŸ” æ¤œç´¢ã¸æˆ»ã‚‹</a>
    </section>
  </main>

  <footer><p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p></footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const PROFILE_NAME = localStorage.getItem("profile_displayName") || null;
    const ROLE  = localStorage.getItem("auth_role") || "user";
    const EMAIL = localStorage.getItem("auth_email") || null;
    const UID   = localStorage.getItem("auth_uid") || null;

    (function () {
      if (EMAIL) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center";
        bar.style.padding = "6px";
        bar.style.background = "#f0f4f8";
        bar.style.color = "#333";
        bar.style.fontSize = "14px";
        bar.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${EMAIL}ï¼ˆå½¹å‰²: ${ROLE}ï¼‰`;
        document.body.prepend(bar);
      }
      if (ROLE !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // å¯¹åº”æ–°çš„è¡¨ç»“æ„ï¼š
    // id, name, description, category, medical_type, address, hours, phone, website, image, link, lat, lng
    const CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";

    const p = new URLSearchParams(location.search);
    const key = (p.get("shop") || "").trim();
    let shopId=null,lastVisible=null,selectedRating=0;
    let currentRow = null; // ä¿å­˜å½“å‰åº—é“ºæ•°æ®ï¼ˆå« lat / lngï¼‰

    if(!key){
      document.getElementById("notFound").style.display="block";
    }else{
      Papa.parse(CSV,{
        download:true,header:true,
        complete:({data})=>{
          // æ ¹æ® id æˆ– name æŸ¥æ‰¾
          let row=data.find(r=>(r.id||"").trim()===key) || data.find(r=>(r.name||"").trim()===key);
          if(!row){
            document.getElementById("notFound").style.display="block";
            return;
          }
          currentRow = row;
          shopId=(row.id||row.name).trim();
          renderBase(row);
          renderDetail(row);
          document.getElementById("commentWrite").style.display="block";
          document.getElementById("commentListSec").style.display="block";
          loadComments(true);
          calcAvgRating();
        }
      });
    }

    function renderBase(r){
      document.getElementById("shopTitle").textContent=r.name||"åº—å";
      document.getElementById("subtitle").textContent = r.category ? `ã‚«ãƒ†ã‚´ãƒª: ${r.category}` : "";
      document.getElementById("heroSection").style.display="block";

      const img=document.getElementById("shopImage");
      if(r.image) img.src=r.image;

      document.getElementById("shopDesc").innerHTML=r.description?`<p>${r.description}</p>`:"";

      const meta=document.getElementById("shopMeta");
      meta.innerHTML="";

      const cat=(r.category||"").trim();
      if(cat){
        const s=document.createElement("span");
        s.className="badge";
        s.textContent=cat;
        meta.append(s);
      }

      const medicalType=(r.medical_type||"").trim();
      if(medicalType){
        const m=document.createElement("span");
        m.className="badge badge-medical";
        m.textContent=medicalType;
        meta.append(m);
      }

      const actions=document.getElementById("shopActions");

      // è®¡ç®— Google Maps å¯¼èˆªé“¾æ¥
      let mapsUrl = "";
      const lat = parseFloat(r.lat);
      const lng = parseFloat(r.lng);
      if (!isNaN(lat) && !isNaN(lng)) {
        // ä½¿ç”¨ç»çº¬åº¦ï¼Œæ›´å‡†ç¡®
        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      } else if (r.address) {
        // fallbackï¼šç”¨åœ°å€æ–‡æœ¬
        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address)}`;
      } else {
        // å†é€€ä¸€æ­¥ï¼šç”¨åº—å
        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name || "")}`;
      }

      actions.innerHTML = `
        <a class="btn" href="map.html?focus=${encodeURIComponent(shopId)}">ğŸ—º åœ°å›³ã§è¦‹ã‚‹</a>
        <a class="btn" href="${mapsUrl}" target="_blank" rel="noopener">ğŸ“ Googleãƒãƒƒãƒ—ã§é–‹ã</a>
        <a class="btn" href="search.html">ğŸ” æ¤œç´¢ã«æˆ»ã‚‹</a>
      `;
    }

    // è¯¦ç»†ä¿¡æ¯å±•ç¤ºï¼ˆè¯»å–æ–°è¡¨å­—æ®µï¼‰
    function renderDetail(r){
      const blocks=[];

      if(r.address){
        blocks.push(`<div><i class="fa-solid fa-location-dot"></i> ${r.address}</div>`);
      }
      if(r.hours){
        blocks.push(`<div><i class="fa-regular fa-clock"></i> ${r.hours}</div>`);
      }
      if(r.phone){
        blocks.push(`<div><i class="fa-solid fa-phone"></i> ${r.phone}</div>`);
      }

      if(r.website){
        blocks.push(
          `<div><i class="fa-solid fa-globe"></i> 
            <a href="${r.website}" target="_blank" rel="noopener">${r.website}</a>
           </div>`
        );
      }

      if(r.link){
        blocks.push(
          `<div><i class="fa-solid fa-up-right-from-square"></i> 
            <a href="${r.link}" target="_blank" rel="noopener">é–¢é€£ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</a>
           </div>`
        );
      }

      const detailEl = document.getElementById("detailContent");
      if (blocks.length){
        detailEl.innerHTML = blocks.join("");
      }else{
        detailEl.innerHTML = "<p class='muted'>è©³ç´°æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      }

      // é¢å¤–æç¤ºä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šç»çº¬åº¦ä¿¡æ¯ï¼Œå¯é€‰ï¼‰
      const extra = [];
      if (r.lat && r.lng){
        extra.push(`åº§æ¨™: ${r.lat}, ${r.lng}`);
      }
      if (extra.length){
        document.getElementById("extraInfo").textContent = extra.join(" / ");
      } else {
        document.getElementById("extraInfo").textContent = "";
      }

      document.getElementById("detailSection").style.display="block";
    }

    function loadComments(reset=false){
      if(!shopId)return;
      const list=document.getElementById("comments");
      const more=document.getElementById("loadMore");
      if(reset){list.innerHTML="";lastVisible=null;}
      let ref=db.collection("shops").doc(shopId).collection("comments").orderBy("time","desc").limit(5);
      if(lastVisible)ref=ref.startAfter(lastVisible);
      ref.get().then(snap=>{
        if(snap.empty){
          more.style.display="none";
          if(reset) list.innerHTML="<small>ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</small>";
          return;
        }
        snap.forEach(doc=>{
          const d=doc.data();
          const time=d.time?.toDate?d.time.toDate():new Date();
          const stars="â˜…".repeat(d.rating||0)+"â˜†".repeat(5-(d.rating||0));
          const row=document.createElement("div");
          row.className="comment";
          row.innerHTML=`
            <strong>${d.name||"åŒ¿å"}</strong> <span class="stars">${stars}</span><br/>
            ${d.text?`<div>${d.text}</div>`:""}
            <small class="muted">${time.getFullYear()}/${time.getMonth()+1}/${time.getDate()} ${time.getHours()}:${String(time.getMinutes()).padStart(2,'0')}</small>
          `;
          list.append(row);
        });
        lastVisible=snap.docs[snap.docs.length-1];
        more.style.display=snap.size<5?"none":"block";
      });
    }
    document.getElementById("loadMore").onclick=()=>loadComments();

    // æ˜µç§°åªè¯»
    if (PROFILE_NAME) {
      const nameInput = document.getElementById("username");
      if (nameInput) {
        nameInput.value = PROFILE_NAME;
        nameInput.readOnly = true;
        nameInput.style.opacity = "0.6";
        nameInput.title = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®è¡¨ç¤ºåãŒä½¿ç”¨ã•ã‚Œã¾ã™";
        const tip = document.createElement("div");
        tip.className = "muted";
        tip.style.marginTop = "6px";
        tip.textContent = `è¡¨ç¤ºåã¨ã—ã¦ã€Œ${PROFILE_NAME}ã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`;
        nameInput.insertAdjacentElement("afterend", tip);
      }
    }

    // æ˜Ÿçº§é€‰æ‹©
    document.querySelectorAll(".star-input").forEach(s=>{
      s.addEventListener("click",()=>{
        selectedRating=parseInt(s.dataset.value);
        document.querySelectorAll(".star-input").forEach(n=>n.classList.remove("selected"));
        for(let i=1;i<=selectedRating;i++){
          const node = document.querySelector(`.star-input[data-value='${i}']`);
          if (node) node.classList.add("selected");
        }
      });
    });

    // å‘é€è¯„è®º
    document.getElementById("commentForm").addEventListener("submit",e=>{
      e.preventDefault();
      const typed=(document.getElementById("username").value||"").trim();
      const name=(PROFILE_NAME&&PROFILE_NAME.trim())?PROFILE_NAME.trim():(typed||"åŒ¿å");
      const text=(document.getElementById("usercomment").value||"").trim();
      if(!text)return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      db.collection("shops").doc(shopId).collection("comments").add({
        name,
        text,
        rating:selectedRating||0,
        uid:UID||null,
        email:EMAIL||null,
        time:new Date()
      }).then(()=>{
        document.getElementById("usercomment").value="";
        selectedRating=0;
        document.querySelectorAll(".star-input").forEach(x=>x.classList.remove("selected"));
        alert("é€ä¿¡ã—ã¾ã—ãŸï¼");
        loadComments(true);
        calcAvgRating();
      });
    });

    function calcAvgRating(){
      if(!shopId)return;
      db.collection("shops").doc(shopId).collection("comments").get().then(snap=>{
        if(snap.empty)return;
        let sum=0;
        snap.forEach(doc=>sum+=(doc.data().rating||0));
        const avg=(sum/snap.size).toFixed(2);
        document.getElementById("ratingSummary").style.display="block";
        document.getElementById("avgRating").innerHTML=`å¹³å‡è©•ä¾¡: <strong>${avg}</strong> / 5ï¼ˆ${snap.size}ä»¶ï¼‰`;
      });
    }
  </script>
  <!-- ç™»å½•æ‹¦æˆª -->
  <script src="auth-guard.js"></script>

  <!-- ç»Ÿä¸€ admin æƒé™è¡¥ä¸ -->
  <script src="auth-util.js"></script>
  <script>
    AuthUtil.refreshRoleAndApplyAdminUI();
  </script>
</body>
</html>
