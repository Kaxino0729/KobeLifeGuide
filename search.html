<!-- æ–‡ä»¶å: search.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>æ¤œç´¢ - ç¥æˆ¸å¤–å›½äººç”Ÿæ´»ã‚¬ã‚¤ãƒ‰</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ä»…æœ¬é¡µå¿…è¦çš„å°‘é‡æ ·å¼ï¼ˆä¸æ”¹åŠ¨å…¨ç«™æ ·å¼ï¼‰ */
    .search-bar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px auto;max-width:860px}
    .search-input{flex:1;min-width:220px;max-width:520px;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    .btn,.chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;text-decoration:none}
    .chip{font-size:14px}
    .chip.active{background:#0a66c2;color:#fff;border-color:#0a66c2}
    .muted{color:#64748b;font-size:12px}
    .result-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;max-width:1000px;margin:18px auto}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{width:100%;height:160px;object-fit:cover;background:#f2f4f7}
    .card-body{padding:12px}
    .badge{display:inline-block;background:#eef;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
    .card-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    @media (max-width:900px){.result-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.result-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ” åº—èˆ—æ¤œç´¢</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <section class="intro" style="text-align:center;max-width:920px;margin:0 auto;">
      <p class="muted">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ã‚«ãƒ†ã‚´ãƒªã§åº—èˆ—ã‚’æ¢ã—ã€ã€Œåº—èˆ—è©³ç´°ã€ã¾ãŸã¯ã€Œåœ°å›³ã§è¦‹ã‚‹ã€ã‹ã‚‰é·ç§»ã§ãã¾ã™ã€‚</p>

      <div class="search-bar">
        <input id="q" class="search-input" type="search" placeholder="åº—åãƒ»èª¬æ˜ã§æ¤œç´¢ï¼ˆä¾‹ï¼šãƒ‰ãƒ³ã‚­ / ãƒ€ã‚¤ã‚½ãƒ¼ / SIM / éŠ€è¡Œï¼‰" />
        <button id="clearBtn" class="btn" title="æ¡ä»¶ã‚¯ãƒªã‚¢"><i class="fa-solid fa-eraser"></i> ã‚¯ãƒªã‚¢</button>
      </div>

      <div id="chips" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px;"></div>

      <div id="stats" class="muted" style="margin-top:8px;">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </section>

    <section class="result-grid" id="results"></section>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- PapaParse è¯»å– CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // ç™»å½•çŠ¶æ€æ¡ï¼ˆä¸ä¾èµ– Firebaseï¼Œä»…ä½¿ç”¨ localStorage å±•ç¤ºï¼‰
    (function () {
      const email = localStorage.getItem("auth_email");
      const role  = localStorage.getItem("auth_role") || "user";
      if (email) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center"; bar.style.padding = "6px";
        bar.style.background = "#f0f4f8"; bar.style.color = "#333"; bar.style.fontSize = "14px";
        bar.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${email}ï¼ˆå½¹å‰²: ${role}ï¼‰`;
        document.body.prepend(bar);
      }
      if (role !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";

    const $q = document.getElementById("q");
    const $chips = document.getElementById("chips");
    const $results = document.getElementById("results");
    const $stats = document.getElementById("stats");
    const $clear = document.getElementById("clearBtn");

    let RAW = [];           // åŸå§‹ CSV è¡Œ
    let CATS = [];          // ç±»åˆ«åˆ—è¡¨
    let state = { q: "", cat: "ã™ã¹ã¦" };

    // è¯»å– URL å‚æ•°ï¼ˆæ”¯æŒç›´è¾¾ï¼‰
    (function initFromQuery(){
      const p = new URLSearchParams(location.search);
      const q = (p.get("q") || "").trim();
      const cat = (p.get("cat") || "").trim();
      if (q) { state.q = q; $q.value = q; }
      if (cat) { state.cat = cat; }
    })();

    // åŠ è½½ CSV
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: ({ data }) => {
        RAW = (data || []).filter(r => (r.name && r.name.trim()) || (r.id && r.id.trim()));
        buildCategories();
        renderChips();
        applyFilter();
        // è¾“å…¥æ—¶å®æ—¶è¿‡æ»¤ï¼ˆå«å›è½¦ï¼‰
        $q.addEventListener("input", debounce(() => { state.q = $q.value.trim(); syncQuery(); applyFilter(); }, 120));
        $q.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); state.q=$q.value.trim(); syncQuery(); applyFilter(); }});
        $clear.addEventListener("click", ()=>{ state.q=""; state.cat="ã™ã¹ã¦"; $q.value=""; renderChips(); syncQuery(); applyFilter(); });
      }
    });

    // åˆ†ç±»å»é‡æ„å»º
    function buildCategories(){
      const set = new Set();
      RAW.forEach(r => {
        const c = (r.category || "").trim();
        if (c) c.split(",").map(s=>s.trim()).filter(Boolean).forEach(x=>set.add(x));
      });
      CATS = ["ã™ã¹ã¦", ...Array.from(set)];
      if (!CATS.includes(state.cat)) state.cat = "ã™ã¹ã¦";
    }

    // æ¸²æŸ“ chips
    function renderChips(){
      $chips.innerHTML = "";
      CATS.forEach(cat => {
        const a = document.createElement("button");
        a.className = "chip" + (cat === state.cat ? " active":"");
        a.textContent = cat;
        a.addEventListener("click", () => {
          state.cat = cat;
          renderChips();
          syncQuery();
          applyFilter();
        });
        $chips.appendChild(a);
      });
    }

    // åŒæ­¥åœ°å€æ ï¼ˆä¾¿äºåˆ†äº« / åˆ·æ–°ä¸ä¸¢æ¡ä»¶ï¼‰
    function syncQuery(){
      const params = new URLSearchParams();
      if (state.q) params.set("q", state.q);
      if (state.cat && state.cat !== "ã™ã¹ã¦") params.set("cat", state.cat);
      const s = params.toString();
      history.replaceState(null, "", s ? `?${s}` : location.pathname);
    }

    // è¿‡æ»¤ & æ¸²æŸ“ç»“æœ
    function applyFilter(){
      const kw = state.q.toLowerCase();
      const cat = state.cat;

      const list = RAW.filter(r => {
        // å…³é”®è¯ï¼šå‘½ä¸­ name/description
        const name = (r.name || "").toLowerCase();
        const desc = (r.description || "").toLowerCase();
        const hitKw = !kw || name.includes(kw) || desc.includes(kw);

        // åˆ†ç±»ï¼šå‘½ä¸­ categoryï¼ˆæ”¯æŒé€—å·åˆ†éš”ï¼‰
        const cats = (r.category || "").split(",").map(s=>s.trim()).filter(Boolean);
        const hitCat = (cat === "ã™ã¹ã¦") || cats.includes(cat);

        return hitKw && hitCat;
      });

      $stats.textContent = `${list.length} ä»¶ãƒ’ãƒƒãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒª: ${cat}${state.q ? ` / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: "${state.q}"`:""}ï¼‰`;
      renderCards(list);
    }

    // å¡ç‰‡æ¸²æŸ“
    function renderCards(list){
      $results.innerHTML = "";
      if (!list.length) {
        $results.innerHTML = `<div class="muted" style="grid-column:1/-1;text-align:center;">è©²å½“ã™ã‚‹åº—èˆ—ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
        return;
      }

      list.forEach(r => {
        const id = (r.id && r.id.trim()) ? r.id.trim() : (r.name || "").trim();
        const img = (r.image && r.image.trim()) ? r.image.trim() : "";
        const cat = (r.category || "").split(",").map(s=>s.trim()).filter(Boolean);
        const desc = (r.description || "").trim();

        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          ${img ? `<img class="thumb" src="${img}" alt="ã‚µãƒ ãƒã‚¤ãƒ«" onerror="this.style.display='none'">` : `<div class="thumb"></div>`}
          <div class="card-body">
            <h3 style="margin:0 0 6px 0;">${r.name || "(åç§°æœªè¨­å®š)"}</h3>
            <div>${cat.map(c=>`<span class="badge">${c}</span>`).join(" ")}</div>
            ${desc ? `<p style="margin:8px 0 0 0;">${desc}</p>` : ""}

            <div class="card-actions">
              <a class="btn" href="shop.html?shop=${encodeURIComponent(id)}"><i class="fa-solid fa-tag"></i> åº—èˆ—è©³ç´°</a>
              <a class="btn" href="map.html?focus=${encodeURIComponent(id)}"><i class="fa-solid fa-map-location-dot"></i> åœ°å›³ã§è¦‹ã‚‹</a>
              ${r.link ? `<a class="btn" href="${r.link}" target="_blank" rel="noopener"><i class="fa-solid fa-up-right-from-square"></i> å…¬å¼/é–¢é€£</a>` : ""}
            </div>
          </div>
        `;
        $results.appendChild(card);
      });
    }

    // ç®€æ˜“é˜²æŠ–
    function debounce(fn, delay){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),delay); };
    }
  </script>
</body>
</html>
