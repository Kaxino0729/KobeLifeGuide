<!-- æ–‡ä»¶å: search.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>æ¤œç´¢ - ç¥æˆ¸å¤–å›½äººç”Ÿæ´»ã‚¬ã‚¤ãƒ‰</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ä»…æœ¬é¡µå¿…è¦çš„å°‘é‡æ ·å¼ï¼ˆä¸æ”¹åŠ¨å…¨ç«™æ ·å¼ï¼‰ */
    .search-bar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px auto;max-width:860px}
    .search-input{flex:1;min-width:220px;max-width:520px;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    .search-select{padding:10px;border:1px solid #cbd5e1;border-radius:10px;min-width:160px}
    .results{max-width:980px;margin:0 auto;padding:12px 14px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{border:1px solid #e2e8f0;border-radius:14px;background:#fff;padding:12px 12px;box-shadow:0 2px 10px rgba(15,23,42,.04)}
    .card h3{margin:0 0 6px 0;font-size:16px}
    .meta{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 8px}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
    .muted{color:#64748b;font-size:12px;line-height:1.5}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:6px;border-radius:10px;padding:8px 10px;border:1px solid #cbd5e1;background:#f8fafc;text-decoration:none;color:#0f172a;font-size:13px}
    .btn:hover{background:#eef2ff}
    .empty{max-width:980px;margin:10px auto;padding:18px;color:#64748b;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ” æ¤œç´¢</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <div class="search-bar">
    <input id="q" class="search-input" type="search" placeholder="ä¾‹ï¼šç—…é™¢ / SIM / ä½ã¾ã„ / å¥‘ç´„ / å½¹æ‰€..." />
    <select id="cat" class="search-select">
      <option value="">ã™ã¹ã¦</option>
      <option value="SIMãƒ»é€šä¿¡">SIMãƒ»é€šä¿¡</option>
      <option value="ä½ã¾ã„ãƒ»è³ƒè²¸">ä½ã¾ã„ãƒ»è³ƒè²¸</option>
      <option value="éŠ€è¡Œãƒ»å£åº§">éŠ€è¡Œãƒ»å£åº§</option>
      <option value="å¸‚å½¹æ‰€ãƒ»åœ¨ç•™">å¸‚å½¹æ‰€ãƒ»åœ¨ç•™</option>
      <option value="å­¦æ ¡ãƒ»å­¦ç±">å­¦æ ¡ãƒ»å­¦ç±</option>
      <option value="ä»•äº‹ãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆ">ä»•äº‹ãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
  </div>

  <div id="results" class="results"></div>
  <div id="empty" class="empty" style="display:none;">è©²å½“ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // ===== Data source (Google Sheets CSV) =====
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?output=csv";

    const $q = document.getElementById("q");
    const $cat = document.getElementById("cat");
    const $results = document.getElementById("results");
    const $empty = document.getElementById("empty");

    let rows = [];

    function safe(v){ return (v == null) ? "" : String(v).trim(); }

    function loadCSV(){
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          rows = (res.data || []).filter(r => r && (r.id || r.name));
          render();
        },
        error: (err) => {
          console.error("CSVèª­ã¿è¾¼ã¿å¤±æ•—:", err);
          $results.innerHTML = "";
          $empty.style.display = "block";
          $empty.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }
      });
    }

    function matchRow(r, q, cat){
      const name = safe(r.name);
      const desc = safe(r.description);
      const category = safe(r.category);

      if (cat && category !== cat) return false;
      if (!q) return true;

      const s = (name + " " + desc + " " + category).toLowerCase();
      return s.includes(q.toLowerCase());
    }

    function render(){
      const q = safe($q.value);
      const cat = safe($cat.value);

      const out = rows.filter(r => matchRow(r, q, cat));

      $results.innerHTML = "";
      $empty.style.display = out.length ? "none" : "block";

      out.forEach(r => {
        const id = safe(r.id);
        const name = safe(r.name) || "(ç„¡é¡Œ)";
        const desc = safe(r.description);
        const category = safe(r.category);
        const img = safe(r.image);
        const addr = safe(r.address);
        const hours = safe(r.hours);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${name}</h3>
          <div class="meta">
            ${category ? `<span class="chip"><i class="fa-solid fa-tag"></i> ${category}</span>` : ""}
            ${r.medical_type ? `<span class="chip"><i class="fa-solid fa-stethoscope"></i> ${safe(r.medical_type)}</span>` : ""}
          </div>
          ${img ? `<img src="${img}" alt="" style="width:100%;border-radius:12px;margin:6px 0 10px;max-height:170px;object-fit:cover">` : ""}
          ${desc ? `<div class="muted">${desc}</div>` : ""}
          ${(addr || hours) ? `<div class="muted" style="margin-top:8px;">
            ${addr ? `<div><i class="fa-solid fa-location-dot"></i> ${addr}</div>` : ""}
            ${hours ? `<div><i class="fa-regular fa-clock"></i> ${hours}</div>` : ""}
          </div>` : ""}
          <div class="actions">
            <a class="btn" href="shop.html?shop=${encodeURIComponent(id)}"><i class="fa-solid fa-tag"></i> åº—èˆ—è©³ç´°</a>
            <a class="btn" href="map.html?focus=${encodeURIComponent(id)}"><i class="fa-solid fa-map-location-dot"></i> åœ°å›³ã§è¦‹ã‚‹</a>
            ${r.link ? `<a class="btn" href="${safe(r.link)}" target="_blank"><i class="fa-solid fa-up-right-from-square"></i> å…¬å¼/é–¢é€£</a>` : ""}
          </div>
        `;
        $results.appendChild(card);
      });
    }

    // ç®€æ˜“é˜²æŠ–
    function debounce(fn, delay){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),delay); };
    }

    $q.addEventListener("input", debounce(render, 150));
    $cat.addEventListener("change", render);

    loadCSV();
  </script>

  <!-- Firebase (for auth-guard stability) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <!-- ç™»å½•æ‹¦æˆª -->
  <script src="auth-guard.js"></script>

  <!--  ç»Ÿä¸€ admin æƒé™è¡¥ä¸ -->
  <script src="auth-util.js"></script>
  <script>
    AuthUtil.refreshRoleAndApplyAdminUI();
  </script>
</body>
</html>
