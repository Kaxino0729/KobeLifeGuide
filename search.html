<!-- 文件名: search.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>店舗検索 - 神戸外国人生活ガイド</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .search-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0;}
    .search-bar input[type="text"]{flex:1;min-width:220px;padding:8px;border:1px solid #999;border-radius:8px;}
    .search-bar select,.search-bar button{padding:8px;border-radius:8px;border:1px solid #999;background:#fff;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;}
    .chip{padding:6px 10px;border:1px solid #cbd5e1;border-radius:999px;cursor:pointer;background:#f8fafc;font-size:14px}
    .chip.active{background:#0a66c2;color:#fff;border-color:#0a66c2}
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
    .card.shop{padding:12px}
    .muted{color:#64748b;font-size:12px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .badge{padding:2px 8px;border-radius:999px;background:#eef;font-size:12px}
    @media (max-width:480px){.search-bar{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <header>
    <h1>🔎 店舗検索</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">🏠 ホーム</a>
      <a href="procedure.html" class="btn">📄 手続きガイド</a>
      <a href="map.html" class="btn">🗺️ マップ</a>
      <a href="review.html" class="btn">⭐ レビュー</a>
      <a href="login.html" class="btn">🔐 ログイン</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2>📍 神戸・三宮周辺の店舗を検索</h2>
      <p class="muted">キーワード、カテゴリ、並び替えで絞り込みできます。位置情報を許可すると距離順の並び替えが可能になります。</p>
    </section>

    <section class="card">
      <div class="search-bar">
        <input id="kw" type="text" placeholder="店名 / 説明 / リンクで検索…" />
        <select id="sort">
          <option value="name">名前順</option>
          <option value="distance">距離順（位置情報）</option>
        </select>
        <button id="locateBtn" title="現在地を取得">📍 現在地</button>
        <button id="clearBtn">クリア</button>
      </div>
      <div id="categoryChips" class="chips"></div>
      <div id="summary" class="muted" style="margin-top:6px;"></div>
    </section>

    <section class="results" id="results"></section>
  </main>

  <footer>
    <p>&copy; 2025 神戸外国人支援プロジェクト</p>
  </footer>

  <!-- PapaParse 读取 CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";

    const $ = sel => document.querySelector(sel);
    const resultsEl = $("#results");
    const summaryEl = $("#summary");
    const chipsEl = $("#categoryChips");
    const kwEl = $("#kw");
    const sortEl = $("#sort");
    const locateBtn = $("#locateBtn");
    const clearBtn = $("#clearBtn");

    let ALL = [];          // 原始数据
    let FILTERED = [];     // 过滤结果
    let CATS = [];         // 类别
    let activeCats = new Set();
    let userPos = null;    // {lat,lng}

    // 读取 CSV
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: ({ data }) => {
        ALL = data
          .filter(r => r && (r.id || r.name))
          .map(r => ({
            id: (r.id && r.id.trim()) || (r.name && r.name.trim()) || "",
            name: r.name || "",
            description: r.description || "",
            link: r.link || "",
            image: r.image || "",
            category: r.category || "",
            lat: r.lat ? parseFloat(r.lat) : null,
            lng: r.lng ? parseFloat(r.lng) : null
          }));
        buildCategories();
        applyFilters();
      }
    });

    function buildCategories() {
      const set = new Set();
      ALL.forEach(x => { if ((x.category || "").trim()) set.add(x.category.trim()); });
      CATS = Array.from(set).sort((a,b) => a.localeCompare(b, "ja"));
      chipsEl.innerHTML = "";
      if (CATS.length === 0) { chipsEl.style.display = "none"; return; }
      chipsEl.style.display = "flex";
      CATS.forEach(cat => {
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = cat;
        div.addEventListener("click", () => {
          if (activeCats.has(cat)) activeCats.delete(cat); else activeCats.add(cat);
          div.classList.toggle("active");
          applyFilters();
        });
        chipsEl.appendChild(div);
      });
    }

    function matchesKw(x, kw) {
      if (!kw) return true;
      const hay = `${x.name}\n${x.description}\n${x.link}`.toLowerCase();
      return hay.includes(kw.toLowerCase());
    }

    function matchesCat(x) {
      if (activeCats.size === 0) return true;
      return activeCats.has((x.category || "").trim());
    }

    function distanceMeters(a, b) {
      if (!a || !b) return Infinity;
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(h));
    }

    function applyFilters() {
      const kw = kwEl.value.trim();
      FILTERED = ALL.filter(x => matchesKw(x, kw) && matchesCat(x));

      const sortBy = sortEl.value;
      if (sortBy === "name") {
        FILTERED.sort((a,b) => (a.name || "").localeCompare(b.name || "", "ja"));
      } else if (sortBy === "distance" && userPos) {
        FILTERED.sort((a,b) => {
          const da = distanceMeters(userPos, {lat:a.lat||0, lng:a.lng||0});
          const db = distanceMeters(userPos, {lat:b.lat||0, lng:b.lng||0});
          return da - db;
        });
      }

      renderResults();
    }

    function renderResults() {
      resultsEl.innerHTML = "";
      summaryEl.textContent = `該当 ${FILTERED.length} 件`;
      if (FILTERED.length === 0) {
        resultsEl.innerHTML = `<div class="card"><small>結果がありません。条件を変更してください。</small></div>`;
        return;
      }
      FILTERED.forEach(x => {
        const dist = (userPos && x.lat && x.lng)
          ? `・約 ${(distanceMeters(userPos,{lat:x.lat,lng:x.lng})/1000).toFixed(2)} km`
          : "";

        const url = x.link ? new URL(x.link, window.location.href) : null;
        const host = url ? url.hostname.replace(/^www\./,'') : "";

        const el = document.createElement("div");
        el.className = "card shop";
        el.innerHTML = `
          <h3 style="margin-top:0">${x.name || "(無名)"} ${x.category ? `<span class="badge">${x.category}</span>` : ""}</h3>
          ${x.image ? `<img src="${x.image}" alt="画像" class="info-img" />` : ""}
          ${x.description ? `<p>${x.description}</p>` : ""}
          <div class="meta muted">
            ${x.lat && x.lng ? `📍 ${x.lat.toFixed(5)}, ${x.lng.toFixed(5)} ${dist}` : ""}
            ${host ? `🔗 ${host}` : ""}
          </div>
          <div class="actions">
            ${x.link ? `<a class="info-link" href="${x.link}" target="_blank">▶ 詳しく見る</a>` : ""}
            <a class="btn" href="map.html?focus=${encodeURIComponent(x.id || x.name || "")}">🗺 地図で見る</a>
            <a class="btn" href="shop.html?shop=${encodeURIComponent(x.id || x.name || "")}">🏷 店舗詳細</a>
            ${x.lat && x.lng ? `<a class="btn" href="https://www.google.com/maps?q=${x.lat},${x.lng}" target="_blank">📍 Googleマップ</a>` : ""}
          </div>
        `;
        resultsEl.appendChild(el);
      });
    }

    kwEl.addEventListener("input", applyFilters);
    sortEl.addEventListener("change", applyFilters);
    clearBtn.addEventListener("click", () => {
      kwEl.value = ""; activeCats.clear();
      chipsEl.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      applyFilters();
    });
    locateBtn.addEventListener("click", () => {
      if (!navigator.geolocation) return alert("位置情報が利用できません。");
      navigator.geolocation.getCurrentPosition(
        pos => {
          userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          if (sortEl.value === "distance") applyFilters();
          else alert("現在地を取得しました。「距離順」に切り替えると近い順で表示されます。");
        },
        err => alert("位置情報の取得に失敗しました: " + err.message),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    // 顶部登录状态条（与其他页面一致）
    (function () {
      const email = localStorage.getItem("auth_email");
      const role  = localStorage.getItem("auth_role");
      if (email) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center";
        bar.style.padding = "6px";
        bar.style.background = "#f0f4f8";
        bar.style.color = "#333";
        bar.style.fontSize = "14px";
        bar.textContent = `ログイン中: ${email}（役割: ${role || "user"}）`;
        document.body.prepend(bar);
      }
    })();
  </script>
</body>
</html>