<!-- æ–‡ä»¶å: profile.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š - ç¥æˆ¸å¤–å›½äººç”Ÿæ´»ã‚¬ã‚¤ãƒ‰</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .profile-card{max-width:560px;margin:16px auto;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:16px}
    .row{margin:10px 0}
    .muted{color:#64748b;font-size:12px}
    .btn-submit{background:#0a66c2;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    input[type="text"],input[type="email"]{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    .hint{background:#f0f4f8;padding:8px;border-radius:8px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2>è¡¨ç¤ºåï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰ã‚’è¨­å®š</h2>
      <p class="muted">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ™‚ã®åå‰ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚æœªãƒ­ã‚°ã‚¤ãƒ³ã®æ–¹ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã€‚</p>
    </section>

    <section class="profile-card">
      <div id="status" class="hint">èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­â€¦</div>

      <div class="row">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input id="email" type="email" disabled />
      </div>

      <div class="row">
        <label>è¡¨ç¤ºåï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰</label>
        <input id="displayName" type="text" placeholder="ä¾‹ï¼šãƒªãƒ¥ã‚¦ / ã•ãã‚‰ / Mike" />
        <div class="muted">â€» 2ã€œ40æ–‡å­—ä»¥å†…ã€å…¬é–‹ã•ã‚Œã‚‹åå‰ã§ã™ã€‚</div>
      </div>

      <div class="row">
        <button id="saveBtn" class="btn-submit">ä¿å­˜</button>
        <a class="btn" href="map.html" style="margin-left:8px;">ğŸ—º ãƒãƒƒãƒ—ã¸æˆ»ã‚‹</a>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ç™»å½•çŠ¶æ€æ¡ & ç®¡ç†å¯è§æ€§
    (function () {
      const email = localStorage.getItem("auth_email");
      const role  = localStorage.getItem("auth_role") || "user";
      if (email) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center"; bar.style.padding = "6px";
        bar.style.background = "#f0f4f8"; bar.style.color = "#333"; bar.style.fontSize = "14px";
        bar.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${email}ï¼ˆå½¹å‰²: ${role}ï¼‰`;
        document.body.prepend(bar);
      }
      if (role !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const statusEl = document.getElementById("status");
    const emailEl  = document.getElementById("email");
    const nameEl   = document.getElementById("displayName");
    const saveBtn  = document.getElementById("saveBtn");

    const uid   = localStorage.getItem("auth_uid");
    const email = localStorage.getItem("auth_email");

    if (!uid || !email) {
      statusEl.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¦ãã ã•ã„ã€‚";
      saveBtn.disabled = true;
    } else {
      statusEl.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";
      emailEl.value = email;
      // è¯»å– Firestore users/{uid}
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          const d = doc.data();
          if (d.displayName) {
            nameEl.value = d.displayName;
            localStorage.setItem("profile_displayName", d.displayName); // æœ¬åœ°ç¼“å­˜
          }
          statusEl.textContent = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™ã€‚";
        } else {
          statusEl.textContent = "åˆå›åˆ©ç”¨ã§ã™ã€‚è¡¨ç¤ºåã‚’è¨­å®šã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚";
        }
      }).catch(err => {
        console.error(err);
        statusEl.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      });
    }

    // ä¿å­˜
    saveBtn.addEventListener("click", async () => {
      if (!uid) return alert("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚");
      const dn = (nameEl.value || "").trim();
      if (dn.length < 2 || dn.length > 40) return alert("è¡¨ç¤ºåã¯2ã€œ40æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        await db.collection("users").doc(uid).set({
          email: email,
          displayName: dn
        }, { merge: true });
        localStorage.setItem("profile_displayName", dn);
        statusEl.textContent = "ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ™‚ã«ã“ã®åå‰ãŒä½¿ã‚ã‚Œã¾ã™ã€‚";
        alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });
  </script>
</body>
</html>