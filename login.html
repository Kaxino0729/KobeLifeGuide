<!-- æ–‡ä»¶å: login.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
    </nav>
  </header>

  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
    <section class="auth-card card">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" />
      <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="loginPassword" placeholder="********" />
      <div class="auth-actions">
        <button class="btn-submit" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="btn-submit" id="pwResetBtn" style="background:#666;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š</button>
      </div>
    </section>

    <!-- æ–°è¦ç™»éŒ² -->
    <section class="auth-card card">
      <h2>æ–°è¦ç™»éŒ²</h2>
      <label for="signupEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input type="email" id="signupEmail" placeholder="you@example.com" />
      <label for="signupPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
      <input type="password" id="signupPassword" placeholder="********" />
      <div class="auth-actions">
        <button class="btn-submit" id="signupBtn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
      </div>
    </section>

    <!-- çŠ¶æ…‹è¡¨ç¤º -->
    <section class="auth-card card">
      <h2>ç¾åœ¨ã®çŠ¶æ…‹</h2>
      <p id="userStatus">æœªãƒ­ã‚°ã‚¤ãƒ³</p>
      <div class="auth-actions">
        <button class="btn-submit" id="logoutBtn" style="background:#a30000;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <small id="authMsg" style="display:block;margin-top:8px;color:#666;"></small>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // â€» ã‚ãªãŸã® Firebase è¨­å®šï¼ˆmap.html ã¨åŒä¸€ã«ã—ã¦ãã ã•ã„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };

    // åˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ï¼ˆä¾‹ï¼š?redirectTo=admin.htmlï¼‰
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const redirectTo = getQueryParam("redirectTo");

    const userStatus = document.getElementById("userStatus");
    const authMsg = document.getElementById("authMsg");

    // --- æ–°è¦ç™»éŒ²ï¼ˆç™»éŒ²å¾Œã« Firestore ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–‡æ›¸ã‚’ä½œæˆï¼‰---
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;

      if (!email || !password) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        authMsg.textContent = "âœ… æ–°è¦ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸ: " + cred.user.email;

        // Firestore ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
        await db.collection("users").doc(cred.user.uid).set({
          email: cred.user.email,
          role: "user",          // â† ç®¡ç†è€…ã«ã—ãŸã„å ´åˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ "admin" ã«å¤‰æ›´
          createdAt: new Date()
        }, { merge: true });

        // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆä»»æ„ï¼‰
        localStorage.setItem("auth_email", cred.user.email);
        localStorage.setItem("auth_uid", cred.user.uid);

      } catch (err) {
        alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });

    // --- ãƒ­ã‚°ã‚¤ãƒ³ ---
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        authMsg.textContent = "âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: " + cred.user.email;

        // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆä»–ãƒšãƒ¼ã‚¸ã§å‚ç…§ï¼‰
        localStorage.setItem("auth_email", cred.user.email);
        localStorage.setItem("auth_uid", cred.user.uid);

        // ä»»æ„ã®ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼ˆ?redirectTo=xxx æŒ‡å®šãŒã‚ã‚‹å ´åˆï¼‰
        if (redirectTo) window.location.href = redirectTo;

      } catch (err) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });

    // --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š ---
    document.getElementById("pwResetBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      if (!email) return alert("å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ã«ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        await auth.sendPasswordResetEmail(email);
        alert("å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚å—ä¿¡ãƒœãƒƒã‚¯ã‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      } catch (err) {
        alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });

    // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await auth.signOut();
      localStorage.removeItem("auth_email");
      localStorage.removeItem("auth_uid");
      authMsg.textContent = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚";
    });

    // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦– ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + user.email;

        // å‚è€ƒï¼šã“ã“ã§ Firestore ã®ãƒ­ãƒ¼ãƒ«ã‚’èª­ã‚€ï¼ˆç®¡ç†è€…åˆ¤å®šãªã©ã«ä½¿ãˆã¾ã™ï¼‰
        try {
          const snap = await db.collection("users").doc(user.uid).get();
          if (snap.exists) {
            const profile = snap.data();
            // ä¾‹ï¼šrole ãŒ admin ãªã‚‰ä½•ã‹è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆâ€¦ãªã©
            console.log("User role:", profile.role);
            // localStorage ã«ä¿æŒã—ã¦ map.html ã§ä½¿ã†ã®ã‚‚OK
            localStorage.setItem("auth_role", profile.role || "user");
          } else {
            localStorage.setItem("auth_role", "user");
          }
        } catch (e) {
          console.warn("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
        }

      } else {
        userStatus.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
        localStorage.removeItem("auth_role");
      }
    });
  </script>
</body>
</html>