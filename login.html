<!-- 文件名: login.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ログイン / 新規登録</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>🔐 ログイン / 新規登録</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">🏠 ホーム</a>
      <a href="procedure.html" class="btn">📄 手続きガイド</a>
      <a href="map.html" class="btn">🗺️ マップ</a>
      <a href="review.html" class="btn">⭐ レビュー</a>
    </nav>
  </header>

  <main>
    <!-- ログイン -->
    <section class="auth-card card">
      <h2>ログイン</h2>
      <label for="loginEmail">メールアドレス</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" />
      <label for="loginPassword">パスワード</label>
      <input type="password" id="loginPassword" placeholder="********" />
      <div class="auth-actions">
        <button class="btn-submit" id="loginBtn">ログイン</button>
        <button class="btn-submit" id="pwResetBtn" style="background:#666;">パスワード再設定</button>
      </div>
    </section>

    <!-- 新規登録 -->
    <section class="auth-card card">
      <h2>新規登録</h2>
      <label for="signupEmail">メールアドレス</label>
      <input type="email" id="signupEmail" placeholder="you@example.com" />
      <label for="signupPassword">パスワード（6文字以上）</label>
      <input type="password" id="signupPassword" placeholder="********" />
      <div class="auth-actions">
        <button class="btn-submit" id="signupBtn">アカウント作成</button>
      </div>
    </section>

    <!-- 状態表示 -->
    <section class="auth-card card">
      <h2>現在の状態</h2>
      <p id="userStatus">未ログイン</p>
      <div class="auth-actions">
        <button class="btn-submit" id="logoutBtn" style="background:#a30000;">ログアウト</button>
      </div>
      <small id="authMsg" style="display:block;margin-top:8px;color:#666;"></small>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 神戸外国人支援プロジェクト</p>
  </footer>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ※ あなたの Firebase 設定（map.html と同一にしてください）
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };

    // 初期化
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ユーティリティ: クエリパラメータ取得（例：?redirectTo=admin.html）
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const redirectTo = getQueryParam("redirectTo");

    const userStatus = document.getElementById("userStatus");
    const authMsg = document.getElementById("authMsg");

    // --- 新規登録（登録後に Firestore にユーザー文書を作成）---
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;

      if (!email || !password) return alert("メールとパスワードを入力してください。");
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        authMsg.textContent = "✅ 新規登録に成功しました: " + cred.user.email;

        // Firestore にプロフィール作成（デフォルトは一般ユーザー）
        await db.collection("users").doc(cred.user.uid).set({
          email: cred.user.email,
          role: "user",          // ← 管理者にしたい場合はコンソールで "admin" に変更
          createdAt: new Date()
        }, { merge: true });

        // ローカル保存（任意）
        localStorage.setItem("auth_email", cred.user.email);
        localStorage.setItem("auth_uid", cred.user.uid);

      } catch (err) {
        alert("登録エラー: " + err.message);
      }
    });

    // --- ログイン ---
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) return alert("メールとパスワードを入力してください。");
      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        authMsg.textContent = "✅ ログイン成功: " + cred.user.email;

        // ローカル保存（他ページで参照）
        localStorage.setItem("auth_email", cred.user.email);
        localStorage.setItem("auth_uid", cred.user.uid);

        // 任意のページへ遷移（?redirectTo=xxx 指定がある場合）
        if (redirectTo) window.location.href = redirectTo;

      } catch (err) {
        alert("ログインエラー: " + err.message);
      }
    });

    // --- パスワード再設定 ---
    document.getElementById("pwResetBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      if (!email) return alert("再設定メールを送るにはメールアドレスを入力してください。");
      try {
        await auth.sendPasswordResetEmail(email);
        alert("再設定メールを送信しました。受信ボックスをご確認ください。");
      } catch (err) {
        alert("送信エラー: " + err.message);
      }
    });

    // --- ログアウト ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await auth.signOut();
      localStorage.removeItem("auth_email");
      localStorage.removeItem("auth_uid");
      authMsg.textContent = "ログアウトしました。";
    });

    // --- 認証状態の監視 ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userStatus.textContent = "ログイン中: " + user.email;

        // 参考：ここで Firestore のロールを読む（管理者判定などに使えます）
        try {
          const snap = await db.collection("users").doc(user.uid).get();
          if (snap.exists) {
            const profile = snap.data();
            // 例：role が admin なら何か表示切り替え…など
            console.log("User role:", profile.role);
            // localStorage に保持して map.html で使うのもOK
            localStorage.setItem("auth_role", profile.role || "user");
          } else {
            localStorage.setItem("auth_role", "user");
          }
        } catch (e) {
          console.warn("ユーザープロフィール取得エラー:", e);
        }

      } else {
        userStatus.textContent = "未ログイン";
        localStorage.removeItem("auth_role");
      }
    });
  </script>
</body>
</html>