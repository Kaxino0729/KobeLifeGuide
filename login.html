<!-- 文件名: login.html（可全覆盖） -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ログイン</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="auth-page">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-brand">
        <div class="auth-logo">◎</div>
        <h1>サインイン</h1>
      </div>

      <div class="auth-card">
        <div class="auth-tabs">
          <button class="auth-tab active" id="tabLogin" type="button">ログイン</button>
          <button class="auth-tab" id="tabSignup" type="button">新規登録</button>
          <button class="auth-tab" id="tabForgot" type="button">再設定</button>
        </div>

        <!-- LOGIN -->
        <section class="auth-view active" id="viewLogin">
          <label for="loginEmail">メールアドレス</label>
          <input type="email" id="loginEmail" placeholder="you@example.com" autocomplete="username" />

          <div class="auth-row">
            <label for="loginPassword">パスワード</label>
            <a href="#forgot" id="linkForgot">パスワードを忘れた？</a>
          </div>
          <input type="password" id="loginPassword" placeholder="********" autocomplete="current-password" />

          <button class="auth-btn" id="loginBtn" type="button">ログイン</button>
          <div class="auth-msg" id="msgLogin"></div>

          <div class="auth-hint">
            ログイン後は自動的にホームへ移動します（または元のページへ戻ります）。
          </div>
        </section>

        <!-- SIGNUP -->
        <section class="auth-view" id="viewSignup">
          <label for="signupEmail">メールアドレス</label>
          <input type="email" id="signupEmail" placeholder="you@example.com" autocomplete="username" />

          <label for="signupPassword">パスワード（6文字以上）</label>
          <input type="password" id="signupPassword" placeholder="********" autocomplete="new-password" />

          <button class="auth-btn" id="signupBtn" type="button">アカウント作成</button>
          <button class="auth-btn secondary" id="backToLogin1" type="button">ログインへ戻る</button>
          <div class="auth-msg" id="msgSignup"></div>

          <div class="auth-hint">
            登録後、ユーザー情報（users/{uid}）を自動作成します。
          </div>
        </section>

        <!-- FORGOT -->
        <section class="auth-view" id="viewForgot">
          <label for="resetEmail">登録メールアドレス</label>
          <input type="email" id="resetEmail" placeholder="you@example.com" autocomplete="email" />

          <button class="auth-btn" id="pwResetBtn" type="button">再設定メールを送信</button>
          <button class="auth-btn secondary" id="backToLogin2" type="button">ログインへ戻る</button>
          <div class="auth-msg" id="msgForgot"></div>

          <div class="auth-hint">
            ※メールが届かない場合：迷惑メール/プロモーションも確認してください。
          </div>
        </section>

        <div class="auth-foot">© 2025 神戸外国人支援プロジェクト</div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== view switch =====
    const tabs = {
      login:  document.getElementById("tabLogin"),
      signup: document.getElementById("tabSignup"),
      forgot: document.getElementById("tabForgot")
    };
    const views = {
      login:  document.getElementById("viewLogin"),
      signup: document.getElementById("viewSignup"),
      forgot: document.getElementById("viewForgot")
    };

    function clearMsgs() {
      ["msgLogin","msgSignup","msgForgot"].forEach(id=>{
        const el=document.getElementById(id);
        el.style.display="none";
        el.className="auth-msg";
        el.textContent="";
      });
    }

    function showView(name){
      Object.values(views).forEach(v=>v.classList.remove("active"));
      Object.values(tabs).forEach(t=>t.classList.remove("active"));
      views[name].classList.add("active");
      tabs[name].classList.add("active");
      clearMsgs();
    }

    function routeByHash(){
      const h=(location.hash||"#login").replace("#","");
      if(h==="signup") showView("signup");
      else if(h==="forgot") showView("forgot");
      else showView("login");
    }

    window.addEventListener("hashchange", routeByHash);
    routeByHash();

    // ★ 修复点：tab 本身绑定点击事件
    tabs.login.addEventListener("click", () => { location.hash = "#login"; });
    tabs.signup.addEventListener("click", () => { location.hash = "#signup"; });
    tabs.forgot.addEventListener("click", () => { location.hash = "#forgot"; });

    document.getElementById("linkForgot").addEventListener("click", (e)=>{
      e.preventDefault();
      location.hash="#forgot";
    });
    document.getElementById("backToLogin1").addEventListener("click", ()=> location.hash="#login");
    document.getElementById("backToLogin2").addEventListener("click", ()=> location.hash="#login");

    function showMsg(el, text, ok){
      el.textContent=text;
      el.style.display="block";
      el.classList.add(ok ? "ok" : "err");
    }

    // ===== users/{uid} 補建 =====
    async function ensureUserDoc(user) {
      const ref = db.collection("users").doc(user.uid);
      const snap = await ref.get();

      if (!snap.exists) {
        await ref.set({
          email: user.email || "",
          role: "user",
          createdAt: new Date()
        }, { merge: true });
      }

      const latest = (await ref.get()).data() || {};
      localStorage.setItem("auth_role", latest.role || "user");
      localStorage.setItem("auth_email", user.email || "");
      localStorage.setItem("auth_uid", user.uid);
    }

    // 新規登録
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      const msg = document.getElementById("msgSignup");

      if (!email || !password) return showMsg(msg, "メールとパスワードを入力してください。", false);
      if (password.length < 6) return showMsg(msg, "パスワードは6文字以上にしてください。", false);

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await ensureUserDoc(cred.user);
        showMsg(msg, "✅ 新規登録に成功しました。", true);
      } catch (err) {
        showMsg(msg, "登録エラー:\n" + (err.message || err), false);
      }
    });

    // ログイン
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      const msg = document.getElementById("msgLogin");

      if (!email || !password) return showMsg(msg, "メールアドレスとパスワードを入力してください。", false);

      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        await ensureUserDoc(cred.user);
        showMsg(msg, "✅ ログイン成功。", true);
      } catch (err) {
        showMsg(msg, "ログインエラー:\n" + (err.message || err), false);
      }
    });

    // パスワード再設定
    document.getElementById("pwResetBtn").addEventListener("click", async () => {
      const email = document.getElementById("resetEmail").value.trim();
      const msg = document.getElementById("msgForgot");
      if (!email) return showMsg(msg, "メールアドレスを入力してください。", false);

      try {
        await auth.sendPasswordResetEmail(email);
        showMsg(msg, "✅ 再設定メールを送信しました。", true);
      } catch (err) {
        showMsg(msg, "送信エラー:\n" + (err.message || err), false);
      }
    });
  </script>

  <!-- 全站登录控制 -->
  <script src="auth-guard.js"></script>
</body>
</html>
