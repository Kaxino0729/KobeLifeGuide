<!-- æ–‡ä»¶å: login.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>

    </nav>
  </header>

  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
    <section class="auth-card card">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" />
      <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="loginPassword" placeholder="********" />
      <div class="auth-actions">
        <button class="btn-submit" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="btn-submit" id="pwResetBtn" style="background:#666;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š</button>
      </div>
    </section>

    <!-- æ–°è¦ç™»éŒ² -->
    <section class="auth-card card">
      <h2>æ–°è¦ç™»éŒ²</h2>
      <label for="signupEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
      <input type="email" id="signupEmail" placeholder="you@example.com" />
      <label for="signupPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
      <input type="password" id="signupPassword" placeholder="********" />
      <div class="auth-actions">
        <button class="btn-submit" id="signupBtn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
      </div>
    </section>

    <!-- çŠ¶æ…‹è¡¨ç¤º -->
    <section class="auth-card card">
      <h2>ç¾åœ¨ã®çŠ¶æ…‹</h2>
      <p id="userStatus">æœªãƒ­ã‚°ã‚¤ãƒ³</p>
      <div class="auth-actions">
        <button class="btn-submit" id="logoutBtn" style="background:#a30000;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <small id="authMsg" style="display:block;margin-top:8px;color:#666;"></small>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ã‚ãªãŸã® Firebase è¨­å®šï¼ˆmap.html ã¨åŒä¸€ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };

    // åˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // util: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?redirectTo=xxx ã‚’å–å¾—
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const redirectTo = getQueryParam("redirectTo");

    const userStatus = document.getElementById("userStatus");
    const authMsg = document.getElementById("authMsg");

    // --- ä¿é™©ï¼šç™»å½•/çŠ¶æ€å˜åŒ–æ—¶ï¼Œç¡®ä¿ Firestore ã« users/{uid} ã‚’è£œå»º ---
    async function ensureUserDoc(user) {
      const ref = db.collection("users").doc(user.uid);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({
          email: user.email || "",
          role: "user",       // é¢„è®¾æ™®é€šç”¨æˆ·ï¼›ç®¡ç†å‘˜è¯·åˆ°æ§åˆ¶å°æ”¹ä¸º "admin"
          createdAt: new Date()
        }, { merge: true });
        console.log("âœ… users æ–‡æ¡£å·²è¡¥å»º:", user.uid);
      }
      // åŒæ­¥è§’è‰²åˆ°æœ¬åœ°ï¼Œæ–¹ä¾¿å…¶ä»–é¡µé¢ç”¨
      const latest = (await ref.get()).data() || {};
      localStorage.setItem("auth_role", latest.role || "user");
    }

    // --- æ–°è¦ç™»éŒ²ï¼ˆæ³¨å†Œåå†™å…¥ users/{uid}ï¼‰---
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      if (!email || !password) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        authMsg.textContent = "âœ… æ–°è¦ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸ: " + cred.user.email;

        await db.collection("users").doc(cred.user.uid).set({
          email: cred.user.email,
          role: "user",
          createdAt: new Date()
        }, { merge: true });

        localStorage.setItem("auth_email", cred.user.email);
        localStorage.setItem("auth_uid", cred.user.uid);
        localStorage.setItem("auth_role", "user");
      } catch (err) {
        alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });

    // --- ãƒ­ã‚°ã‚¤ãƒ³ ---
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) return alert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        authMsg.textContent = "âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: " + cred.user.email;
        localStorage.setItem("auth_email", cred.user.email);
        localStorage.setItem("auth_uid", cred.user.uid);
        // è¿™é‡Œä¸è·³ ensureUserDocï¼Œäº¤ç»™ onAuthStateChanged ç»Ÿä¸€å¤„ç†

        if (redirectTo) window.location.href = redirectTo;
      } catch (err) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });

    // --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š ---
    document.getElementById("pwResetBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      if (!email) return alert("å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ã«ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      try {
        await auth.sendPasswordResetEmail(email);
        alert("å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚å—ä¿¡ãƒœãƒƒã‚¯ã‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      } catch (err) {
        alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message);
      }
    });

    // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await auth.signOut();
      localStorage.removeItem("auth_email");
      localStorage.removeItem("auth_uid");
      localStorage.removeItem("auth_role");
      authMsg.textContent = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚";
    });

    // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ï¼šç™»å½•åè‡ªåŠ¨è¡¥å»ºæ¡£&åŒæ­¥è§’è‰² ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + user.email;
        localStorage.setItem("auth_email", user.email);
        localStorage.setItem("auth_uid", user.uid);

        try {
          await ensureUserDoc(user);   // ğŸ‘ˆ å…³é”®ï¼šç™»å½•æ—¶ä¹Ÿç¡®ä¿ Firestore å»ºå¥½æ¡£æ¡ˆ
        } catch (e) {
          console.warn("ensureUserDoc å¤±è´¥:", e);
          alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä½œæˆ/å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
        }
      } else {
        userStatus.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
        localStorage.removeItem("auth_email");
        localStorage.removeItem("auth_uid");
        localStorage.removeItem("auth_role");
      }
    });
  </script>
  <script src="auth-guard.js"></script>
</body>
</html>