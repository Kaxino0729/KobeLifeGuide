<!-- æ–‡ä»¶å: procedure.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰ï¼ˆWikié¢¨æ²ç¤ºæ¿ï¼‰</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- EasyMDEï¼ˆMarkdownã‚¨ãƒ‡ã‚£ã‚¿ï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css" />
  <style>
    .toolbar {display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toolbar .search {flex:1;min-width:220px}
    .toolbar input,.toolbar select {padding:8px;border:1px solid #ccc;border-radius:8px;width:100%}
    .toolbar .btn {padding:8px 12px;border-radius:8px;background:#0a66c2;color:#fff;text-decoration:none;border:none;cursor:pointer}
    .guide-list {max-width:980px;margin:12px auto}
    .guide-card {background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px 14px;margin:10px 0}
    .guide-card h3{margin:0 0 6px 0}
    .meta {color:#64748b;font-size:12px;display:flex;gap:8px;flex-wrap:wrap}
    .badge {background:#eef;padding:2px 8px;border-radius:999px;font-size:12px}
    .tag {background:#f0f9ff;color:#0369a1;padding:2px 8px;border-radius:999px;font-size:12px}
    .actions a,.actions button{margin-left:8px}
    .muted {color:#64748b}
    .viewer {background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;max-width:980px;margin:16px auto}
    .viewer h2{margin-top:0}
    .hidden{display:none}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;max-width:960px;width:92%;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .modal header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #eee}
    .modal .body{padding:12px 14px}
    .modal .row{display:grid;grid-template-columns:120px 1fr;gap:10px;margin:8px 0}
    .modal input,.modal select,.modal textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;padding:10px 14px;border-top:1px solid #eee}
    .danger{background:#dc2626}
    .btn-secondary{background:#e5e7eb;color:#111}
    @media (max-width:640px){.modal .row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰ï¼ˆç•™å­¦ç”Ÿå‘ã‘ Wikiï¼‰</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main class="guide-list">
    <section class="intro">
      <p class="muted">åœ¨æ—¥ç•™å­¦ç”Ÿã®ãŸã‚ã®å®Ÿç”¨ã‚¬ã‚¤ãƒ‰ã€‚SIMãƒ»ä½ã¾ã„ãƒ»éŠ€è¡Œãƒ»å¸‚å½¹æ‰€æ‰‹ç¶šããªã©ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚</p>
    </section>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆæ¤œç´¢/ã‚«ãƒ†ã‚´ãƒª/ã‚¿ã‚°/æ–°è¦ï¼‰ -->
    <div class="toolbar">
      <div class="search" title="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ã‹ã‚‰æ¤œç´¢">
        <input id="q" type="search" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆä¾‹ï¼šSIM / åœ¨ç•™ã‚«ãƒ¼ãƒ‰ / ä½æ°‘ç¥¨ï¼‰">
      </div>
      <div style="width:180px">
        <select id="cat">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          <option>SIMãƒ»é€šä¿¡</option>
          <option>ä½ã¾ã„ãƒ»è³ƒè²¸</option>
          <option>éŠ€è¡Œãƒ»å£åº§</option>
          <option>å¸‚å½¹æ‰€ãƒ»åœ¨ç•™</option>
          <option>å­¦æ ¡ãƒ»å­¦ç±</option>
          <option>ä»•äº‹ãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
          <option>ãã®ä»–</option>
        </select>
      </div>
      <div style="width:200px">
        <input id="tag" type="text" placeholder="ã‚¿ã‚°ï¼ˆä¾‹ï¼šæœªæˆå¹´, ä¿é™º, ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ï¼‰">
      </div>
      <button id="newBtn" class="btn admin-only" title="æ–°ã—ã„ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆ">ï¼‹ æ–°è¦ä½œæˆ</button>
    </div>

    <!-- ã‚¬ã‚¤ãƒ‰ä¸€è¦§ -->
    <div id="list"></div>

    <!-- è©³ç´°ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰ -->
    <article id="viewer" class="viewer hidden">
      <h2 id="vTitle">ã‚¿ã‚¤ãƒˆãƒ«</h2>
      <div class="meta" id="vMeta"></div>
      <div id="vBody" style="margin-top:12px"></div>
    </article>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Modal: ç·¨é›†/æ–°è¦ -->
  <div class="modal-backdrop" id="modalWrap">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle">ã‚¬ã‚¤ãƒ‰ç·¨é›†</h3>
        <button id="closeModal" class="btn btn-secondary">âœ–</button>
      </header>
      <div class="body">
        <div class="row">
          <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="fTitle" type="text" placeholder="ä¾‹ï¼šSIMã‚«ãƒ¼ãƒ‰ã®å¥‘ç´„æ‰‹é †ï¼ˆæœªæˆå¹´ã®å ´åˆï¼‰">
        </div>
        <div class="row">
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="fCat">
            <option>SIMãƒ»é€šä¿¡</option>
            <option>ä½ã¾ã„ãƒ»è³ƒè²¸</option>
            <option>éŠ€è¡Œãƒ»å£åº§</option>
            <option>å¸‚å½¹æ‰€ãƒ»åœ¨ç•™</option>
            <option>å­¦æ ¡ãƒ»å­¦ç±</option>
            <option>ä»•äº‹ãƒ»ã‚¢ãƒ«ãƒã‚¤ãƒˆ</option>
            <option>ãã®ä»–</option>
          </select>
        </div>
        <div class="row">
          <label>ã‚¿ã‚°</label>
          <input id="fTags" type="text" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼šæœªæˆå¹´, ä¿é™º, ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼">
        </div>
        <div class="row" style="display:block">
          <label style="display:block;margin-bottom:6px">æœ¬æ–‡ï¼ˆMarkdownï¼‰</label>
          <textarea id="fBody"></textarea>
        </div>
        <div class="row">
          <label>å…¬é–‹</label>
          <select id="fPublished">
            <option value="true">å…¬é–‹</option>
            <option value="false">éå…¬é–‹ï¼ˆä¸‹æ›¸ãï¼‰</option>
          </select>
        </div>
      </div>
      <footer>
        <button id="delBtn" class="btn danger admin-only">å‰Šé™¤</button>
        <button id="saveBtn" class="btn">ä¿å­˜</button>
      </footer>
    </div>
  </div>

  <!-- Firebase & libs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    /* ====== èªè¨¼çŠ¶æ…‹ï¼ˆç°¡æ˜“ãƒ˜ãƒƒãƒ€ãƒãƒ¼ & æ¨©é™UIï¼‰ ====== */
    const ROLE  = localStorage.getItem("auth_role") || "user";
    const EMAIL = localStorage.getItem("auth_email") || null;
    const UID   = localStorage.getItem("auth_uid") || null;
    (function () {
      if (EMAIL) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center";
        bar.style.padding = "6px";
        bar.style.background = "#f0f4f8";
        bar.style.color = "#333";
        bar.style.fontSize = "14px";
        bar.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${EMAIL}ï¼ˆå½¹å‰²: ${ROLE}ï¼‰`;
        document.body.prepend(bar);
      }
      if (ROLE !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    /* ====== Firebase åˆæœŸåŒ– ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ====== UI å‚ç…§ ====== */
    const $q = document.getElementById("q");
    const $cat = document.getElementById("cat");
    const $tag = document.getElementById("tag");
    const $list = document.getElementById("list");
    const $viewer = document.getElementById("viewer");
    const $vTitle = document.getElementById("vTitle");
    const $vMeta = document.getElementById("vMeta");
    const $vBody = document.getElementById("vBody");

    const $modalWrap = document.getElementById("modalWrap");
    const $modalTitle = document.getElementById("modalTitle");
    const $closeModal = document.getElementById("closeModal");
    const $newBtn = document.getElementById("newBtn");
    const $saveBtn = document.getElementById("saveBtn");
    const $delBtn = document.getElementById("delBtn");

    const $fTitle = document.getElementById("fTitle");
    const $fCat = document.getElementById("fCat");
    const $fTags = document.getElementById("fTags");
    const $fBody = document.getElementById("fBody");
    const $fPublished = document.getElementById("fPublished");

    let editor = null;
    let editingId = null; // doc id
    let cache = []; // loaded guides (for client filter)

    /* ====== ã‚¨ãƒ‡ã‚£ã‚¿åˆæœŸåŒ– ====== */
    function ensureEditor() {
      if (!editor) {
        editor = new EasyMDE({
          element: $fBody,
          spellChecker: false,
          minHeight: "200px",
          renderingConfig: { singleLineBreaks: false },
          autofocus: false
        });
      }
    }

    /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ ====== */
    function openModal(title = "ã‚¬ã‚¤ãƒ‰ç·¨é›†") {
      $modalTitle.textContent = title;
      $modalWrap.style.display = "flex";
      ensureEditor();
    }
    function closeModal() {
      $modalWrap.style.display = "none";
      editingId = null;
      if (editor) editor.value("");
      $fTitle.value = "";
      $fCat.value = "SIMãƒ»é€šä¿¡";
      $fTags.value = "";
      $fPublished.value = "true";
    }
    $closeModal.onclick = closeModal;

    /* ====== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ======
      guides/{docId}:
        title: string
        category: string
        tags: array<string>
        body: string (markdown)
        published: boolean
        updatedAt: timestamp
        author: { uid, email }
    ================================= */

    /* ====== ä¸€è¦§å–å¾— & ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ====== */
    async function loadGuides() {
      const snap = await db.collection("guides")
        .orderBy("updatedAt","desc")
        .limit(100)
        .get();
      cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderList();
    }

    function renderList() {
      const q = ($q.value || "").toLowerCase().trim();
      const cat = ($cat.value || "").trim();
      const tag = ($tag.value || "").toLowerCase().trim();

      const filtered = cache.filter(g => {
        if (!g.published && ROLE !== "admin") return false;
        const hitQ = !q || (g.title||"").toLowerCase().includes(q)
                      || (g.body||"").toLowerCase().includes(q)
                      || (g.tags||[]).join(",").toLowerCase().includes(q);
        const hitCat = !cat || (g.category === cat);
        const hitTag = !tag || (g.tags||[]).some(t => (t||"").toLowerCase().includes(tag));
        return hitQ && hitCat && hitTag;
      });

      $list.innerHTML = filtered.map(g => {
        const date = g.updatedAt?.toDate ? g.updatedAt.toDate() : (g.updatedAt || new Date());
        const dstr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
        const tags = (g.tags||[]).map(t => `<span class="tag">${t}</span>`).join(" ");
        const isDraft = g.published ? "" : `<span class="badge" style="background:#fee2e2;color:#b91c1c">ä¸‹æ›¸ã</span>`;
        return `
          <div class="guide-card" data-id="${g.id}">
            <h3 style="margin:0">
              <a href="javascript:void(0)" class="open">${g.title||"(ç„¡é¡Œ)"}</a>
            </h3>
            <div class="meta">
              <span class="badge">${g.category || "ãã®ä»–"}</span>
              ${isDraft}
              ${tags}
              <span class="muted">æ›´æ–°æ—¥ï¼š${dstr}</span>
            </div>
            <div class="actions" style="margin-top:6px;">
              <a class="btn btn-secondary open" href="javascript:void(0)">èª­ã‚€</a>
              ${ROLE==="admin" ? `
                <button class="btn btn-secondary edit">ç·¨é›†</button>
                <button class="btn danger delete">å‰Šé™¤</button>
              ` : ""}
            </div>
          </div>
        `;
      }).join("") || `<p class="muted">ä¸€è‡´ã™ã‚‹ã‚¬ã‚¤ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;

      // bind
      $list.querySelectorAll(".open").forEach(a=>{
        a.onclick = (ev)=>{
          const card = ev.target.closest(".guide-card");
          const id = card?.dataset?.id;
          const g = cache.find(x=>x.id===id);
          if (g) openViewer(g);
        };
      });
      if (ROLE==="admin") {
        $list.querySelectorAll(".edit").forEach(b=>{
          b.onclick = (ev)=>{
            const card = ev.target.closest(".guide-card");
            const id = card?.dataset?.id;
            const g = cache.find(x=>x.id===id);
            if (g) openEditor(g);
          };
        });
        $list.querySelectorAll(".delete").forEach(b=>{
          b.onclick = async (ev)=>{
            const card = ev.target.closest(".guide-card");
            const id = card?.dataset?.id;
            if (!confirm("ã“ã®ã‚¬ã‚¤ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
              await db.collection("guides").doc(id).delete();
              await loadGuides();
              alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            } catch(e){
              console.error(e); alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™/ãƒ«ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
            }
          };
        });
      }
    }

    function openViewer(g){
      $viewer.classList.remove("hidden");
      $vTitle.textContent = g.title || "(ç„¡é¡Œ)";
      const date = g.updatedAt?.toDate ? g.updatedAt.toDate() : (g.updatedAt || new Date());
      const dstr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
      const tags = (g.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(" ");
      $vMeta.innerHTML = `
        <span class="badge">${g.category || "ãã®ä»–"}</span>
        ${g.published ? "" : `<span class="badge" style="background:#fee2e2;color:#b91c1c">ä¸‹æ›¸ã</span>`}
        ${tags}
        <span class="muted">æ›´æ–°æ—¥ï¼š${dstr}</span>
      `;
      $vBody.innerHTML = marked.parse(g.body || "_ï¼ˆæœ¬æ–‡ãªã—ï¼‰_");
      window.scrollTo({ top: $viewer.offsetTop - 12, behavior: "smooth" });
    }

    /* ====== æ–°è¦/ç·¨é›† ====== */
    function openEditor(g=null){
      if (ROLE!=="admin") return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      editingId = g?.id || null;
      $modalTitle.textContent = editingId ? "ã‚¬ã‚¤ãƒ‰ç·¨é›†" : "ã‚¬ã‚¤ãƒ‰æ–°è¦";
      $fTitle.value = g?.title || "";
      $fCat.value = g?.category || "SIMãƒ»é€šä¿¡";
      $fTags.value = (g?.tags || []).join(", ");
      ensureEditor();
      editor.value(g?.body || "");
      $fPublished.value = String(!!g?.published);
      $delBtn.style.display = editingId ? "inline-block" : "none";
      openModal();
    }

    async function saveGuide(){
      if (ROLE!=="admin") return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      const title = $fTitle.value.trim();
      const category = $fCat.value.trim() || "ãã®ä»–";
      const tags = ($fTags.value||"").split(",").map(s=>s.trim()).filter(Boolean);
      const body = editor ? editor.value() : ($fBody.value || "");
      const published = $fPublished.value === "true";
      if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      const payload = {
        title, category, tags, body, published,
        updatedAt: new Date(),
        author: { uid: UID||null, email: EMAIL||null }
      };
      try{
        if (editingId) {
          await db.collection("guides").doc(editingId).set(payload, { merge:true });
        } else {
          const docRef = await db.collection("guides").add(payload);
          editingId = docRef.id;
        }
        await loadGuides();
        closeModal();
        alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
      }catch(e){
        console.error(e); alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™/ãƒ«ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      }
    }

    $saveBtn.onclick = saveGuide;
    $newBtn && ($newBtn.onclick = ()=>openEditor(null));
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    /* ====== ãƒ•ã‚£ãƒ«ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
    [$q,$cat,$tag].forEach(el => el.addEventListener("input", ()=>renderList()));

    /* ====== åˆæœŸãƒ­ãƒ¼ãƒ‰ ====== */
    loadGuides().catch(e=>console.error(e));
  </script>
</body>
</html>
