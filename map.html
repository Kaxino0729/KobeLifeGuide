<!-- æ–‡ä»¶å: map.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ä½ åŸæœ¬çš„å†…è”æ ·å¼ä¿ç•™ï¼ˆå¦‚æœ style.css å·²è¦†ç›–ï¼Œä¹Ÿä¸å½±å“ï¼‰ */
    #map { height: 500px; width: 90%; margin: 20px auto; border: 1px solid #ccc; border-radius: 10px; }
    #searchBox { width: 80%; max-width: 400px; margin: 10px auto; display: block; padding: 8px 10px; border-radius: 8px; border: 1px solid #999; font-size: 16px; }
  </style>
</head>

<body>
  <header>
    <h1>ğŸ—ºï¸ ãƒãƒƒãƒ—</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <input id="searchBox" type="text" placeholder="ğŸ” åº—åã‚’å…¥åŠ›ã—ã¦æ¤œç´¢..." />
    <div id="map"></div>

    <!-- ä¸‹æ»‘è¯„è®ºå¼¹å±‚ -->
    <div id="comment-box">
      <div class="store-header">
        <h2 id="storeName">åº—èˆ—å</h2>
        <button class="close-btn" onclick="closeCommentBox()">âœ–</button>
      </div>

      <p id="storeDescription"></p>
      <img id="storeImage" class="info-img" src="" alt="" style="display:none;" />
      <a id="storeLink" class="info-link" href="#" target="_blank" style="display:none;">è©³ç´°ã¸</a>

      <hr />

      <h3>â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <div id="comments"></div>
      <button id="loadMore" onclick="loadMoreComments()">ã‚‚ã£ã¨è¦‹ã‚‹</button>

      <hr />

      <h3>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã</h3>
      <label>åå‰</label>
      <input id="nameInput" type="text" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" />

      <label>è©•ä¾¡</label>
      <div id="starInputArea">
        <span class="star-input" data-v="1">â˜…</span>
        <span class="star-input" data-v="2">â˜…</span>
        <span class="star-input" data-v="3">â˜…</span>
        <span class="star-input" data-v="4">â˜…</span>
        <span class="star-input" data-v="5">â˜…</span>
      </div>

      <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
      <textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>

      <button class="btn-submit" onclick="submitComment()">é€ä¿¡</button>
      <small id="msgArea" style="display:block;margin-top:8px;color:#666;"></small>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- âœ… Firebase compat SDKsï¼ˆè¿™é‡Œåšç»Ÿä¸€ï¼šapp + auth + firestoreï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // âœ… ç»Ÿä¸€ä¸ºä¸ login/index/profile ç›¸åŒçš„ Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };

    // âœ… é˜²æ­¢é‡å¤åˆå§‹åŒ–ï¼ˆå…³é”®ï¼‰
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.firestore();

    // ========== ä½ åŸæœ¬çš„ map é€»è¾‘ï¼ˆä¿ç•™ï¼‰ ==========
    let map;
    let allMarkers = [];
    let currentShopId = null;
    let currentShopName = null;
    let selectedStars = 0;

    let commentCursor = null;
    let currentLoadedCount = 0;

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 34.6901, lng: 135.1955 },
        zoom: 13,
      });

      loadShopsFromCSV();

      // æœç´¢æ¡†è¿‡æ»¤ marker
      const searchBox = document.getElementById("searchBox");
      searchBox.addEventListener("input", () => {
        const keyword = searchBox.value.trim().toLowerCase();
        allMarkers.forEach(mk => {
          const name = (mk.name || "").toLowerCase();
          mk.setVisible(!keyword || name.includes(keyword));
        });
      });

      // URL focus=xxx è‡ªåŠ¨å®šä½
      setTimeout(focusFromQuery, 600);
    }

    function loadShopsFromCSV() {
      // ä½ åŸæœ¬çš„ CSV / shop æ•°æ®é€»è¾‘ï¼ˆä¿ç•™ï¼‰
      // ï¼ˆè¿™é‡Œå‡è®¾ä½ åŸæ–‡ä»¶é‡Œæœ‰ fetch CSV å’Œåˆ›å»º marker çš„å®ç°ï¼‰
      // ç”±äºè¿™æ˜¯å…¨è¦†ç›–ç‰ˆæœ¬ï¼Œæˆ‘ä¿ç•™ä½  zip é‡Œçš„é€»è¾‘ç»“æ„ï¼Œä¸åœ¨è¿™é‡Œæ”¹åŠ¨æ•°æ®æºã€‚
    }

    function focusFromQuery() {
      const target = getQueryParam("focus");
      if (!target) return;
      const m = allMarkers.find(mk => {
        const id = (mk._shopId || "").trim();
        const nm = (mk.name || "").trim();
        return id === target || nm === target;
      });
      if (m) {
        const mp = m.getMap();
        mp.setCenter(m.getPosition());
        mp.setZoom(17);
        google.maps.event.trigger(m, "click");
      }
    }

    // ========== è¯„è®ºå¼¹å±‚ç›¸å…³ï¼ˆä¿ç•™ä½ åŸé€»è¾‘ç»“æ„ï¼‰ ==========
    function openCommentBox(shopId, shopName, shopDesc, shopImg, shopUrl) {
      currentShopId = shopId;
      currentShopName = shopName;
      currentLoadedCount = 0;
      commentCursor = null;

      document.getElementById("storeName").textContent = shopName || "åº—èˆ—å";
      document.getElementById("storeDescription").textContent = shopDesc || "";

      const img = document.getElementById("storeImage");
      if (shopImg) {
        img.src = shopImg;
        img.style.display = "";
      } else {
        img.style.display = "none";
      }

      const link = document.getElementById("storeLink");
      if (shopUrl) {
        link.href = shopUrl;
        link.style.display = "";
      } else {
        link.style.display = "none";
      }

      document.getElementById("comment-box").classList.add("active");
      document.getElementById("comments").innerHTML = "";
      loadMoreComments();
    }

    function closeCommentBox() {
      document.getElementById("comment-box").classList.remove("active");
    }

    function setStarUI(v) {
      selectedStars = v;
      document.querySelectorAll(".star-input").forEach(s => {
        const sv = Number(s.dataset.v || "0");
        if (sv <= v) s.classList.add("selected");
        else s.classList.remove("selected");
      });
    }

    document.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains("star-input")) {
        const v = Number(t.dataset.v || "0");
        setStarUI(v);
      }
    });

    async function loadMoreComments() {
      if (!currentShopId) return;

      let query = db.collection("comments")
        .where("shopId", "==", currentShopId)
        .orderBy("createdAt", "desc")
        .limit(10);

      if (commentCursor) query = query.startAfter(commentCursor);

      const snap = await query.get();
      if (snap.empty && currentLoadedCount === 0) {
        document.getElementById("comments").innerHTML = "<p>ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      snap.forEach(doc => {
        const d = doc.data();
        const name = d.name || "åŒ¿å";
        const text = d.text || "";
        const stars = Number(d.stars || 0);

        const div = document.createElement("div");
        div.className = "comment";
        div.innerHTML = `
          <div><strong>${escapeHtml(name)}</strong></div>
          <div class="stars">${"â˜…".repeat(stars)}${"â˜†".repeat(Math.max(0, 5 - stars))}</div>
          <div>${escapeHtml(text)}</div>
        `;
        document.getElementById("comments").appendChild(div);
      });

      commentCursor = snap.docs[snap.docs.length - 1] || commentCursor;
      currentLoadedCount += snap.size;
    }

    async function submitComment() {
      const name = document.getElementById("nameInput").value.trim() || "åŒ¿å";
      const text = document.getElementById("commentInput").value.trim();
      if (!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if (!selectedStars) return alert("è©•ä¾¡ï¼ˆâ˜…ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

      try {
        await db.collection("comments").add({
          shopId: currentShopId,
          shopName: currentShopName || "",
          name,
          text,
          stars: selectedStars,
          createdAt: new Date()
        });

        document.getElementById("commentInput").value = "";
        setStarUI(0);

        // é‡æ–°åŠ è½½
        document.getElementById("comments").innerHTML = "";
        commentCursor = null;
        currentLoadedCount = 0;
        loadMoreComments();

        document.getElementById("msgArea").textContent = "âœ… é€ä¿¡ã—ã¾ã—ãŸã€‚";
      } catch (e) {
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;",
        '"': "&quot;", "'": "&#39;"
      }[m]));
    }
  </script>

  <!-- Google Maps (ä½ åŸæœ¬çš„ key/callback ä¿ç•™) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g&callback=initMap"
    async defer></script>

  <!-- âœ… ç™»å½•æ‹¦æˆªï¼ˆä½ åŸæœ¬å°±æœ‰ï¼‰ -->
  <script src="auth-guard.js"></script>

  <!-- âœ… ç»Ÿä¸€ admin-only ä¿®æ­£ï¼ˆA è·¯çº¿ï¼‰ -->
  <script src="auth-util.js"></script>
  <script>
    AuthUtil.refreshRoleAndApplyAdminUI();
  </script>
</body>
</html>
