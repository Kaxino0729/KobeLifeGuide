<!-- æ–‡ä»¶å: map.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒãƒƒãƒ— - åº—èˆ—æƒ…å ±</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    #map { height: 500px; width: 90%; margin: 20px auto; border: 1px solid #ccc; border-radius: 10px; }
    #searchBox { width: 80%; max-width: 400px; margin: 10px auto; display: block; padding: 8px 10px; border-radius: 8px; border: 1px solid #999; font-size: 16px; }

    /* è¿½åŠ ï¼šå¼¹å±‚æŒ‰é’®æ’ç‰ˆï¼ˆä¸å½±å“å…¨ç«™ï¼Œåªå½±å“ map.htmlï¼‰ */
    .info-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .info-link { display:inline-block; padding:8px 10px; border-radius:8px; text-decoration:none; background:#0a66c2; color:#fff; font-size:14px; }
    .info-link.secondary { background:#666; }
  </style>
</head>

<body>
  <header>
    <h1>ğŸ—ºï¸ ãƒãƒƒãƒ—</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a>
      <!-- ç®¡ç†è€…å°‚ç”¨ -->
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <p style="text-align:center;margin:10px 0 0;">ç¥æˆ¸å‘¨è¾ºã®ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆã‚’åœ°å›³ã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚</p>
    <input type="text" id="searchBox" placeholder="åº—åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">

    <!-- åˆ†ç±»chipsï¼šç”±JSæ ¹æ®CSVä¸­çš„categoryåŠ¨æ€ç”Ÿæˆ -->
    <div id="categoryFilters" style="text-align:center;margin:10px 0;"></div>

    <div id="map"></div>

    <!-- ä¸‹æ»‘è¯„è®ºå¼¹å±‚ -->
    <div id="comment-box">
      <div class="store-header">
        <h3 id="storeName">åº—èˆ—å</h3>
        <button class="close-btn" onclick="closeCommentBox()">âœ–</button>
      </div>

      <div id="storeMeta" style="font-size:13px;color:#666;"></div>
      <p id="storeDescription"></p>

      <div style="display:flex; gap:10px; align-items:flex-start;">
        <img id="storeImage" class="info-img" alt="" style="display:none;" />
        <div style="flex:1;">
          <!-- âœ… è¿™é‡Œæ›¿æ¢ï¼šåŸæ¥çš„ storeLink(è©³ç´°ã¸) æ”¹ä¸ºæŒ‰é’®ç»„ -->
          <div class="info-actions">
            <a id="storeDetail" class="info-link" href="#">è©³ç´°ã¸</a>
            <a id="storeOfficial" class="info-link secondary" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">å…¬å¼ã‚µã‚¤ãƒˆ</a>
            <a id="storeGmap" class="info-link secondary" href="#" target="_blank" rel="noopener noreferrer">Googleãƒãƒƒãƒ—</a>
          </div>
        </div>
      </div>

      <hr>

      <div id="ratingArea" style="margin:8px 0;">
        <strong>è©•ä¾¡:</strong>
        <span class="star-input" data-v="1">â˜…</span>
        <span class="star-input" data-v="2">â˜…</span>
        <span class="star-input" data-v="3">â˜…</span>
        <span class="star-input" data-v="4">â˜…</span>
        <span class="star-input" data-v="5">â˜…</span>
        <small style="margin-left:8px;color:#666;">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰</small>
      </div>

      <div style="margin:8px 0;">
        <input id="username" type="text" placeholder="åå‰ï¼ˆä»»æ„ï¼‰">
      </div>

      <div style="margin:8px 0;">
        <textarea id="usercomment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>
      </div>

      <button id="submit" class="btn-submit">é€ä¿¡</button>

      <hr>

      <div class="comment-list">
        <h4>ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</h4>
        <div id="comments"></div>
        <button id="loadMore" class="btn-submit" style="background:#666;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // âœ… çµ±ä¸€ï¼šlogin/index/profile ã¨åŒã˜ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // ====== ã“ã“ã‹ã‚‰ä¸‹ã¯å…ƒã® map.html ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¿æŒï¼‰ ======
    const ROLE  = localStorage.getItem("auth_role") || "user";
    const EMAIL = localStorage.getItem("auth_email") || null;
    const UID   = localStorage.getItem("auth_uid") || null;

    // âš ï¸ ä½ çš„ map.html è¿™é‡Œç”¨çš„æ˜¯ profile_nameï¼ˆè€Œ shop.html ç”¨çš„æ˜¯ profile_displayNameï¼‰
    // å…ˆä¿æŒä¸åŠ¨ï¼ˆæŒ‰ä½ â€œæœ€å°ä¿®æ”¹â€åŸåˆ™ï¼‰ã€‚åç»­ä½ è¦ç»Ÿä¸€æ˜µç§°æ—¶å†ä¸€èµ·æ”¹ã€‚
    const PROFILE_NAME = localStorage.getItem("profile_name") || "";

    if (ROLE !== "admin") {
      document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    }

    let map;
    let markers = [];
    let markerById = new Map();
    let allRows = [];
    let currentShopId = null;
    let currentShopName = null;
    let selectedRating = 0;

    let lastVisibleDoc = null;
    let isLoading = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 34.6901, lng: 135.1955 },
        zoom: 13,
      });

      loadShops();

      const searchBox = document.getElementById("searchBox");
      searchBox.addEventListener("input", () => {
        const keyword = (searchBox.value || "").trim().toLowerCase();
        markers.forEach(mk => {
          const name = (mk.shopName || "").toLowerCase();
          const cat  = (mk.category || "").toLowerCase();
          mk.setVisible(!keyword || name.includes(keyword) || cat.includes(keyword));
        });
      });

      // æ˜Ÿé€‰æ‹©
      document.querySelectorAll(".star-input").forEach(el => {
        el.addEventListener("click", () => {
          selectedRating = Number(el.dataset.v || "0");
          document.querySelectorAll(".star-input").forEach(s => {
            const v = Number(s.dataset.v || "0");
            if (v <= selectedRating) s.classList.add("selected");
            else s.classList.remove("selected");
          });
        });
      });

      // æäº¤è¯„è®º
      document.getElementById("submit").addEventListener("click", () => {
        if (!currentShopId) return alert("åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        const name = (document.getElementById("username").value || "").trim() || (PROFILE_NAME || "åŒ¿å");
        const text = (document.getElementById("usercomment").value || "").trim();
        if (!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        db.collection("shops").doc(currentShopId).collection("comments").add({
          uid: UID || null,
          email: EMAIL || null,
          name,
          text,
          rating: selectedRating || 0,
          time: new Date()
        }).then(() => {
          document.getElementById("usercomment").value = "";
          document.getElementById("username").value = PROFILE_NAME || "";
          selectedRating = 0;
          document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));

          document.getElementById("comments").innerHTML = "<small>èª­ã¿è¾¼ã¿ä¸­...</small>";
          loadComments(true);
        }).catch(err => {
          alert("é€ä¿¡å¤±æ•—: " + err.message);
        });
      });

      document.getElementById("loadMore").addEventListener("click", () => {
        loadComments(false);
      });
    }

    function loadShops() {
      const shopCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";

      Papa.parse(shopCsvUrl, {
        download: true,
        header: true,
        complete: (results) => {
          allRows = (results.data || []).filter(r => r && (r.id || r.name));
          renderCategoryFilters(allRows);
          createMarkers(allRows);
        },
        error: (err) => {
          console.error("CSVèª­ã¿è¾¼ã¿å¤±æ•—:", err);
          alert("åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      });
    }

    function renderCategoryFilters(rows) {
      const box = document.getElementById("categoryFilters");
      box.innerHTML = "";

      const cats = Array.from(new Set(rows.map(r => (r.category || "").trim()).filter(Boolean)));
      const allBtn = document.createElement("button");
      allBtn.textContent = "ã™ã¹ã¦";
      allBtn.className = "btn-submit";
      allBtn.style.margin = "0 6px 6px 0";
      allBtn.style.background = "#0a66c2";
      allBtn.onclick = () => {
        markers.forEach(m => m.setVisible(true));
      };
      box.appendChild(allBtn);

      cats.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = "btn-submit";
        btn.style.margin = "0 6px 6px 0";
        btn.style.background = "#666";
        btn.onclick = () => {
          const kw = cat.toLowerCase();
          markers.forEach(mk => {
            const c = (mk.category || "").toLowerCase();
            mk.setVisible(c === kw);
          });
        };
        box.appendChild(btn);
      });
    }

    function createMarkers(rows) {
      // å…ˆæ¸…ç†
      markers.forEach(m => m.setMap(null));
      markers = [];
      markerById.clear();

      rows.forEach(r => {
        const lat = Number(r.lat || r.latitude);
        const lng = Number(r.lng || r.longitude);
        if (!isFinite(lat) || !isFinite(lng)) return;

        const shopId = (r.id || "").trim() || (r.name || "").trim();
        const shopName = (r.name || "åº—èˆ—").trim();
        const category = (r.category || "").trim();
        const desc = (r.description || r.desc || "").trim();
        const img = (r.image || r.img || "").trim();
        const url = (r.url || r.link || "").trim();
        const address = (r.address || "").trim();

        const marker = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: shopName
        });

        marker.shopId = shopId;
        marker.shopName = shopName;
        marker.category = category;

        marker.addListener("click", () => {
          openCommentBox({
            shopId, shopName, category, desc, img, url, address,
            lat, lng
          });
        });

        markers.push(marker);
        markerById.set(shopId, marker);
      });
    }

    function openCommentBox(info) {
      currentShopId = info.shopId;
      currentShopName = info.shopName;

      document.getElementById("storeName").textContent = info.shopName || "åº—èˆ—å";
      document.getElementById("storeMeta").textContent =
        `${info.category || ""} / (${info.lat?.toFixed?.(5) || ""}, ${info.lng?.toFixed?.(5) || ""})`;

      document.getElementById("storeDescription").textContent = info.desc || "";

      const img = document.getElementById("storeImage");
      if (info.img) {
        img.src = info.img;
        img.style.display = "";
      } else {
        img.style.display = "none";
      }

      // âœ… å…³é”®æ”¹åŠ¨ï¼š3 ä¸ªæŒ‰é’®çš„è¡Œä¸º
      const shopKey = (info.shopId || info.shopName || "").trim();
      const detailBtn = document.getElementById("storeDetail");
      detailBtn.href = `shop.html?shop=${encodeURIComponent(shopKey)}`;
      detailBtn.style.display = "";

      const officialBtn = document.getElementById("storeOfficial");
      if ((info.url || "").trim()) {
        officialBtn.href = info.url.trim();
        officialBtn.style.display = "";
      } else {
        officialBtn.style.display = "none";
      }

      const gmapBtn = document.getElementById("storeGmap");
      const lat = Number(info.lat);
      const lng = Number(info.lng);
      let gmapUrl = "";
      if (isFinite(lat) && isFinite(lng)) {
        gmapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      } else if ((info.address || "").trim()) {
        gmapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(info.address.trim())}`;
      } else if ((info.shopName || "").trim()) {
        gmapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(info.shopName.trim())}`;
      } else {
        gmapUrl = "https://www.google.com/maps";
      }
      gmapBtn.href = gmapUrl;

      document.getElementById("username").value = PROFILE_NAME || "";
      document.getElementById("usercomment").value = "";
      selectedRating = 0;
      document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));

      document.getElementById("comment-box").classList.add("active");
      document.getElementById("comments").innerHTML = "<small>èª­ã¿è¾¼ã¿ä¸­...</small>";
      lastVisibleDoc = null;
      loadComments(true);
    }

    function closeCommentBox() {
      document.getElementById("comment-box").classList.remove("active");
    }

    function loadComments(reset) {
      if (!currentShopId) return;
      if (isLoading) return;
      isLoading = true;

      let q = db.collection("shops").doc(currentShopId).collection("comments")
        .orderBy("time", "desc")
        .limit(8);

      if (!reset && lastVisibleDoc) {
        q = q.startAfter(lastVisibleDoc);
      }

      q.get().then(snap => {
        if (reset) document.getElementById("comments").innerHTML = "";

        snap.docs.forEach(doc => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = "comment";
          const stars = Number(d.rating || 0);
          div.innerHTML = `
            <div><strong>${escapeHtml(d.name || "åŒ¿å")}</strong></div>
            <div class="stars">${"â˜…".repeat(stars)}${"â˜†".repeat(Math.max(0, 5 - stars))}</div>
            <div>${escapeHtml(d.text || "")}</div>
          `;
          document.getElementById("comments").appendChild(div);
        });

        lastVisibleDoc = snap.docs[snap.docs.length - 1] || lastVisibleDoc;
      }).catch(err => {
        console.warn("comments load err:", err);
      }).finally(() => {
        isLoading = false;
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;",
        '"': "&quot;", "'": "&#39;"
      }[m]));
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g&callback=initMap"></script>

  <!-- ç™»å½•æ‹¦æˆª -->
  <script src="auth-guard.js"></script>

  <!-- ç»Ÿä¸€ admin æƒé™è¡¥ä¸ -->
  <script src="auth-util.js"></script>
  <script>
    AuthUtil.refreshRoleAndApplyAdminUI();
  </script>
</body>
</html>
