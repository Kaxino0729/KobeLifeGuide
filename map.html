<!-- map.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒƒãƒ— - åº—èˆ—æƒ…å ±</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <h1>ğŸ—ºï¸ ç¥æˆ¸å‘¨è¾ºãƒãƒƒãƒ—</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2>ğŸ“ ãŠã™ã™ã‚ã®ãŠåº—</h2>
      <p>ç¥æˆ¸ãƒ»ä¸‰å®®å‘¨è¾ºã®ä¾¿åˆ©ãªãŠåº—ã‚„æ–½è¨­ã‚’åœ°å›³ã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚</p>
      <input type="text" id="searchBox" placeholder="åº—åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
    </section>
    <div id="map"></div>
  </main>

  <!-- è¯„è®ºå¼¹çª— -->
  <div id="comment-box">
    <div class="store-header">
      <h2 id="shop-name">åº—å</h2>
      <button id="close-btn" class="close-btn" title="é–‰ã˜ã‚‹">âœ–</button>
    </div>
    <form id="comment-form">
      <input type="text" id="username" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰"><br>
      <textarea id="usercomment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>
      <div id="rating-stars" class="star-rating">
        <span class="star-input" data-value="1">â˜…</span>
        <span class="star-input" data-value="2">â˜…</span>
        <span class="star-input" data-value="3">â˜…</span>
        <span class="star-input" data-value="4">â˜…</span>
        <span class="star-input" data-value="5">â˜…</span>
      </div>
      <button type="submit" class="btn-submit">é€ä¿¡</button>
    </form>
    <div id="comments"></div>
    <button id="loadMore" style="display:none">ã‚‚ã£ã¨è¦‹ã‚‹</button>
  </div>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <!-- CSV è§£æ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    let allMarkers = [], currentShopId = null, lastVisible = null, selectedRating = 0;

    function initMap() {
      const center = { lat: 34.6951, lng: 135.1955 };
      const map = new google.maps.Map(document.getElementById("map"), { zoom: 15, center });

      Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv", {
        download: true,
        header: true,
        complete: ({data}) => {
          allMarkers = data.map(place => {
            if (!place.lat || !place.lng) return null;
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(place.lat), lng: parseFloat(place.lng) },
              map
            });
            const infoWindow = new google.maps.InfoWindow({
              content: `<strong>${place.name}</strong><br>${place.description || ''}`
            });
            marker.addListener("click", () => {
              infoWindow.open(map, marker);
              currentShopId = place.id || place.name;
              document.getElementById("shop-name").textContent = place.name;
              document.getElementById("comment-box").classList.add("active");
              document.getElementById("comments").innerHTML = "<small>èª­ã¿è¾¼ã¿ä¸­...</small>";
              loadComments(true);
            });
            marker.name = place.name;
            marker.description = place.description;
            marker.infoWindow = infoWindow;
            return marker;
          }).filter(m => m);
        }
      });

      document.getElementById("searchBox").addEventListener("input", e => {
        const keyword = e.target.value.toLowerCase();
        allMarkers.forEach(marker => {
          const match = marker.name.toLowerCase().includes(keyword) || (marker.description || '').toLowerCase().includes(keyword);
          marker.setVisible(match);
          if (!match && marker.infoWindow) marker.infoWindow.close();
        });
      });

      map.addListener("click", () => document.getElementById("comment-box").classList.remove("active"));
    }

    document.getElementById("close-btn").onclick = () => document.getElementById("comment-box").classList.remove("active");

    function loadComments(reset = false) {
      const ref = db.collection("shops").doc(currentShopId).collection("comments").orderBy("time", "desc").limit(5);
      let query = reset ? ref : ref.startAfter(lastVisible);
      query.get().then(snapshot => {
        const container = document.getElementById("comments");
        if (reset) container.innerHTML = "";
        if (snapshot.empty) {
          document.getElementById("loadMore").style.display = "none";
          if (reset) container.innerHTML = "<small>ã‚³ãƒ¡ãƒ³ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</small>";
          return;
        }
        snapshot.forEach(doc => {
          const data = doc.data();
          const t = data.time?.toDate?.() || new Date();
          const timeStr = `${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}`;
          const stars = "â˜…".repeat(data.rating || 0) + "â˜†".repeat(5 - (data.rating || 0));
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `<strong>${data.name || "åŒ¿å"}</strong> <small>ï¼ˆ${timeStr}ï¼‰</small><br><div class='stars'>${stars}</div>${data.text}`;
          container.appendChild(div);
        });
        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        document.getElementById("loadMore").style.display = snapshot.size < 5 ? "none" : "block";
      });
    }

    document.getElementById("loadMore").onclick = () => loadComments();

    document.querySelectorAll(".star-input").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = parseInt(star.dataset.value);
        document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));
        for (let i = 1; i <= selectedRating; i++) {
          document.querySelector(`.star-input[data-value='${i}']`).classList.add("selected");
        }
      });
    });

    document.getElementById("comment-form").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("username").value.trim();
      const text = document.getElementById("usercomment").value.trim();
      if (!text || !currentShopId) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      db.collection("shops").doc(currentShopId).collection("comments").add({
        name: name || "åŒ¿å",
        text,
        rating: selectedRating,
        time: new Date()
      }).then(() => {
        document.getElementById("usercomment").value = "";
        document.getElementById("username").value = "";
        selectedRating = 0;
        document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));
        alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚");
        loadComments(true);
      });
    });
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g&callback=initMap"></script>
</body>
</html>
