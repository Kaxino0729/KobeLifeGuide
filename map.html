<!-- æ–‡ä»¶å: map.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒãƒƒãƒ— - åº—èˆ—æƒ…å ±</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    #map { height: 500px; width: 90%; margin: 20px auto; border: 1px solid #ccc; border-radius: 10px; }
    #searchBox { width: 80%; max-width: 400px; margin: 10px auto; display: block; padding: 8px 10px; border-radius: 8px; border: 1px solid #999; font-size: 16px; }
    .cat-btn { background:#e8f0fe; border:1px solid #90caf9; border-radius:999px; padding:4px 10px; margin:3px; font-size:14px; cursor:pointer; }
    .cat-btn.active { background:#0a66c2; color:#fff; }
    .info-img { width: 100%; max-width: 150px; margin-top: 6px; border-radius: 5px; }
    .info-link { display:inline-block; margin-top:8px; padding:4px 8px; background:#0a66c2; color:#fff; text-decoration:none; border-radius:4px; font-size:13px; }

    /* ä¸‹æ»‘è¯„è®ºé¢æ¿ */
    #comment-box { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); transition: bottom 0.4s; padding: 1em; z-index: 999; }
    #comment-box.active { bottom: 0; }
    .store-header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .close-btn { background:none; border:none; font-size:20px; cursor:pointer; }
    #comments { max-height: 240px; overflow-y: auto; margin-top: 10px; }
    .comment { border-top:1px solid #eee; background:#f8faff; margin-bottom:6px; padding:8px; border-radius:4px; }
    .stars { color:#ffc107; font-size:16px; margin-left:4px; }
    .star-rating { margin: 6px 0; }
    .star-input { font-size:20px; color:#ccc; cursor:pointer; }
    .star-input.selected { color:#ffc107; }
    .btn-submit { background:#0a66c2; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    #loadMore { background:#eee; border:none; padding:6px 12px; margin-top:10px; border-radius:5px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ—ºï¸ ç¥æˆ¸å‘¨è¾ºãƒãƒƒãƒ—</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
      <a href="search.html" class="btn">ğŸ” æ¤œç´¢</a>
      <a href="profile.html" class="btn">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="login.html" class="btn">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
      <a href="admin.html" class="btn admin-only">ğŸ›  ç®¡ç†</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2>ğŸ“ ãŠã™ã™ã‚ã®ãŠåº—</h2>
      <p>ç¥æˆ¸ãƒ»ä¸‰å®®å‘¨è¾ºã®ä¾¿åˆ©ãªãŠåº—ã‚„æ–½è¨­ã‚’åœ°å›³ã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚</p>
      <input type="text" id="searchBox" placeholder="åº—åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">

      <!-- åˆ†ç±»ç­›é€‰ï¼ˆå¯æŒ‰éœ€å¢å‡æŒ‰é’®æˆ–æ”¹ä¸ºåŠ¨æ€ç”Ÿæˆï¼‰ -->
      <div id="categoryFilters" style="text-align:center;margin:10px 0;">
        <button class="cat-btn active" data-cat="all">ã™ã¹ã¦</button>
        <button class="cat-btn" data-cat="ç”Ÿæ´»ç”¨å“">ç”Ÿæ´»ç”¨å“</button>
        <button class="cat-btn" data-cat="é€šä¿¡">é€šä¿¡</button>
        <button class="cat-btn" data-cat="é£²é£Ÿ">é£²é£Ÿ</button>
        <button class="cat-btn" data-cat="éŠ€è¡Œ">éŠ€è¡Œ</button>
      </div>
    </section>
    <div id="map"></div>
  </main>

  <!-- è¯„è®ºå¼¹å±‚ï¼ˆä¿æŒä½ åŸå…ˆç»“æ„ï¼‰ -->
  <div id="comment-box">
    <div class="store-header">
      <h2 id="shop-name">åº—å</h2>
      <button id="close-btn" class="close-btn" title="é–‰ã˜ã‚‹">âœ–</button>
    </div>
    <div id="store-info" style="margin-bottom:8px;"></div>

    <form id="comment-form">
      <input type="text" id="username" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰"><br>
      <textarea id="usercomment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>

      <div id="rating-stars" class="star-rating">
        <span class="star-input" data-value="1">â˜…</span>
        <span class="star-input" data-value="2">â˜…</span>
        <span class="star-input" data-value="3">â˜…</span>
        <span class="star-input" data-value="4">â˜…</span>
        <span class="star-input" data-value="5">â˜…</span>
      </div>
      <button type="submit" class="btn-submit">é€ä¿¡</button>
    </form>

    <div class="comment-list">
      <h4>ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</h4>
      <div id="comments"></div>
      <button id="loadMore" style="display:none">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.firebasestorage.app",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ROLE  = localStorage.getItem("auth_role") || "user";
    const EMAIL = localStorage.getItem("auth_email") || null;
    const UID   = localStorage.getItem("auth_uid") || null;
    const PROFILE_NAME = localStorage.getItem("profile_displayName") || null;

    (function () {
      if (EMAIL) {
        const bar = document.createElement("div");
        bar.style.textAlign = "center";
        bar.style.padding = "6px";
        bar.style.background = "#f0f4f8";
        bar.style.color = "#333";
        bar.style.fontSize = "14px";
        bar.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${EMAIL}ï¼ˆå½¹å‰²: ${ROLE || "user"}ï¼‰`;
        document.body.prepend(bar);
      }
      if (ROLE !== "admin") document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    })();

    let allMarkers = [];
    let currentShopId = null;
    let lastVisible = null;
    let selectedRating = 0;
    let currentCategory = "all";

    function getQueryParam(name){
      const p = new URLSearchParams(window.location.search);
      return p.get(name);
    }

    function focusFromQuery() {
      const target = getQueryParam("focus");
      if (!target) return;
      const m = allMarkers.find(mk => {
        const id = (mk._shopId || "").trim();
        const nm = (mk.name || "").trim();
        return id === target || nm === target;
      });
      if (m) {
        const map = m.getMap();
        map.setCenter(m.getPosition());
        map.setZoom(17);
        google.maps.event.trigger(m, "click");
      }
    }

    function initMap() {
      const center = { lat: 34.6951, lng: 135.1955 };
      const map = new google.maps.Map(document.getElementById("map"), { zoom: 15, center });

      Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv", {
        download: true,
        header: true,
        complete: ({ data }) => {
          allMarkers = data.map(place => {
            if (!place.lat || !place.lng) return null;

            const marker = new google.maps.Marker({
              position: { lat: parseFloat(place.lat), lng: parseFloat(place.lng) },
              map
            });

            marker._shopId = (place.id && place.id.trim()) ? place.id.trim() : (place.name || "");
            marker.name = place.name || "";
            marker.description = place.description || "";
            marker.category = (place.category || ""); // â˜… ç”¨äºåˆ†ç±»è¿‡æ»¤

            const infoHtml = [
              `<strong>${place.name || ""}</strong>`,
              place.description ? `<br>${place.description}` : "",
              place.image ? `<br><img class="info-img" src="${place.image}" alt="ç”»åƒ">` : "",
              place.link ? `<br><a class="info-link" href="${place.link}" target="_blank">â–¶ è©³ã—ãè¦‹ã‚‹</a>` : "",
              `<br><a class="info-link" href="shop.html?shop=${encodeURIComponent(marker._shopId)}">ğŸ· åº—èˆ—è©³ç´°</a>`
            ].join("");

            const infoWindow = new google.maps.InfoWindow({ content: infoHtml });
            marker.infoWindow = infoWindow; // â˜… ä¾›è¿‡æ»¤æ—¶å…³é—­ç”¨

            marker.addListener("click", () => {
              infoWindow.open(map, marker);
              currentShopId = marker._shopId;

              document.getElementById("shop-name").textContent = place.name || "åº—å";
              document.getElementById("store-info").innerHTML = `
                ${place.description ? `<p>${place.description}</p>` : ""}
                ${place.link ? `<p><a class="info-link" href="${place.link}" target="_blank">â–¶ è©³ã—ãè¦‹ã‚‹</a></p>` : ""}
                ${place.image ? `<img class="info-img" src="${place.image}" alt="ç”»åƒ">` : ""}
                <p style="margin-top:6px">
                  <a class="info-link" href="shop.html?shop=${encodeURIComponent(marker._shopId)}">ğŸ· åº—èˆ—è©³ç´°ãƒšãƒ¼ã‚¸ã¸</a>
                </p>
              `;

              // æ˜µç§°åªè¯»æç¤º
              const nameInput = document.getElementById("username");
              if (PROFILE_NAME && nameInput) {
                nameInput.value = PROFILE_NAME;
                nameInput.readOnly = true;
                nameInput.style.opacity = "0.6";
                nameInput.title = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®è¡¨ç¤ºåãŒä½¿ç”¨ã•ã‚Œã¾ã™";
                const after = nameInput.nextElementSibling;
                if (!after || !after.classList || !after.classList.contains("muted")) {
                  const tip = document.createElement("div");
                  tip.className = "muted";
                  tip.style.marginTop = "6px";
                  tip.textContent = `è¡¨ç¤ºåã¨ã—ã¦ã€Œ${PROFILE_NAME}ã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`;
                  nameInput.insertAdjacentElement("afterend", tip);
                }
              }

              document.getElementById("comment-box").classList.add("active");
              document.getElementById("comments").innerHTML = "<small>èª­ã¿è¾¼ã¿ä¸­...</small>";
              loadComments(true);
            });

            return marker;
          }).filter(Boolean);

          focusFromQuery();
        }
      });

      // å…³é”®è¯è¿‡æ»¤
      document.getElementById("searchBox").addEventListener("input", filterMarkers);

      // åˆ†ç±»æŒ‰é’®äº‹ä»¶
      document.querySelectorAll(".cat-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".cat-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentCategory = btn.dataset.cat;
          filterMarkers();
        });
      });

      // åœ°å›¾ç©ºç™½å¤„ç‚¹å‡» â†’ æ”¶èµ·è¯„è®ºé¢æ¿
      map.addListener("click", () => {
        document.getElementById("comment-box").classList.remove("active");
      });

      function filterMarkers() {
        const keyword = document.getElementById("searchBox").value.toLowerCase();
        allMarkers.forEach(marker => {
          const matchKeyword = marker.name.toLowerCase().includes(keyword) ||
                               (marker.description || '').toLowerCase().includes(keyword);
          const matchCat = currentCategory === "all" ||
                           (marker.category && marker.category.includes(currentCategory));
          const visible = matchKeyword && matchCat;
          marker.setVisible(visible);
          if (!visible && marker.infoWindow) marker.infoWindow.close();
        });
      }
    }

    // å…³é—­å¼¹å±‚
    document.getElementById("close-btn").onclick = () => {
      document.getElementById("comment-box").classList.remove("active");
    };

    // åŠ è½½è¯„è®ºï¼ˆåˆ†é¡µï¼‰
    function loadComments(reset = false) {
      if (!currentShopId) return;

      const listEl = document.getElementById("comments");
      const moreBtn = document.getElementById("loadMore");
      if (reset) { listEl.innerHTML = ""; lastVisible = null; }

      let ref = db.collection("shops").doc(currentShopId)
                  .collection("comments")
                  .orderBy("time", "desc")
                  .limit(5);
      if (lastVisible) ref = ref.startAfter(lastVisible);

      ref.get().then(snapshot => {
        if (snapshot.empty) {
          moreBtn.style.display = "none";
          if (reset) listEl.innerHTML = "<small>ã‚³ãƒ¡ãƒ³ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</small>";
          return;
        }

        snapshot.forEach(doc => {
          const d = doc.data();
          const t = d.time?.toDate ? d.time.toDate() : new Date();
          const timeStr = `${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}`;
          const stars = "â˜…".repeat(d.rating || 0) + "â˜†".repeat(5 - (d.rating || 0));

          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `
            <strong>${d.name || "åŒ¿å"}</strong>
            <span class="stars">${stars}</span><br/>
            ${d.text ? `<div>${d.text}</div>` : ""}
            <small>${timeStr}</small>
          `;
          listEl.appendChild(div);
        });

        lastVisible = snapshot.docs[snapshot.docs.length - 1];
        moreBtn.style.display = snapshot.size < 5 ? "none" : "block";
      }).catch(err => {
        console.error("ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:", err);
      });
    }

    document.getElementById("loadMore").onclick = () => loadComments(false);

    // æ˜Ÿçº§é€‰æ‹©
    document.querySelectorAll(".star-input").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = parseInt(star.dataset.value, 10);
        document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));
        for (let i = 1; i <= selectedRating; i++) {
          const node = document.querySelector(`.star-input[data-value='${i}']`);
          if (node) node.classList.add("selected");
        }
      });
    });

    // å‘é€è¯„è®º
    document.getElementById("comment-form").addEventListener("submit", e => {
      e.preventDefault();
      if (!currentShopId) return alert("åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");

      const typed = (document.getElementById("username").value || "").trim();
      const name  = (PROFILE_NAME && PROFILE_NAME.trim()) ? PROFILE_NAME.trim() : (typed || "åŒ¿å");
      const text  = (document.getElementById("usercomment").value || "").trim();
      if (!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      db.collection("shops").doc(currentShopId).collection("comments").add({
        uid: UID || null,
        email: EMAIL || null,
        name,
        text,
        rating: selectedRating || 0,
        time: new Date()
      }).then(() => {
        document.getElementById("usercomment").value = "";
        document.getElementById("username").value = PROFILE_NAME || "";
        selectedRating = 0;
        document.querySelectorAll(".star-input").forEach(s => s.classList.remove("selected"));
        alert("ã‚³ãƒ¡ãƒ³ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚");
        loadComments(true);
      }).catch(err => {
        console.error("é€ä¿¡å¤±æ•—:", err);
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    });
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g&callback=initMap"></script>
</body>
</html>
