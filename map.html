<!-- æ–‡ä»¶å: map.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒƒãƒ— - åº—èˆ—æƒ…å ±</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <h1>ğŸ—ºï¸ ç¥æˆ¸å‘¨è¾ºãƒãƒƒãƒ—</h1>
    <nav class="navbar">
      <a href="index.html" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
      <a href="procedure.html" class="btn">ğŸ“„ æ‰‹ç¶šãã‚¬ã‚¤ãƒ‰</a>
      <a href="map.html" class="btn">ğŸ—ºï¸ ãƒãƒƒãƒ—</a>
      <a href="review.html" class="btn">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2>ğŸ“ ãŠã™ã™ã‚ã®ãŠåº—</h2>
      <p>ç¥æˆ¸ãƒ»ä¸‰å®®å‘¨è¾ºã®ä¾¿åˆ©ãªãŠåº—ã‚„æ–½è¨­ã‚’åœ°å›³ã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚</p>
      <input type="text" id="searchBox" placeholder="åº—åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
    </section>
    <div id="map"></div>

    <!-- åº—èˆ—è©³ç´° & ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ï¼ˆä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºï¼‰ -->
    <div id="storeDetail" class="store-detail">
      <div class="store-header">
        <h3 id="storeName"></h3>
        <button id="closeDetail" class="close-btn">âœ–</button>
      </div>
      <div id="storeInfo"></div>

      <div class="comment-section">
        <h4>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã</h4>
        <form id="commentForm">
          <input type="text" id="userName" placeholder="åå‰ã‚’å…¥åŠ›" required>
          <textarea id="userComment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›" required></textarea>

          <!-- æ˜Ÿè©•ä¾¡ -->
          <div class="star-rating">
            <span data-value="5">â˜…</span>
            <span data-value="4">â˜…</span>
            <span data-value="3">â˜…</span>
            <span data-value="2">â˜…</span>
            <span data-value="1">â˜…</span>
          </div>
          <input type="hidden" id="rating" value="0">

          <button type="submit">é€ä¿¡</button>
        </form>
      </div>

      <div class="comment-list">
        <h4>ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</h4>
        <div id="comments"></div>
        <button id="loadMoreBtn" style="display:none;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 ç¥æˆ¸å¤–å›½äººæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
  </footer>

   <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyB8dt1NgMhBtKlUeFzCAzImuKKjzKCrOTM",
      authDomain: "kobe-life-guide.firebaseapp.com",
      projectId: "kobe-life-guide",
      storageBucket: "kobe-life-guide.appspot.com",
      messagingSenderId: "440390213094",
      appId: "1:440390213094:web:508d4e03409ca338b54a27"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let allMarkers = [];
    let currentStoreId = null;
    let lastVisible = null; // åˆ†é¡µç”¨

    function initMap() {
      const center = { lat: 34.6951, lng: 135.1955 }; // ä¸‰å®®é§…
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15, center: center
      });

      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRdoRvyh8AKmNq032tjbaVhv0nEhjsrWD-r0dQopKqu0z6RjDN5BJ2tCX5-Z3CnlKiDuyBn7lPiGBh/pub?gid=0&single=true&output=csv";
      Papa.parse(csvUrl, {
        download: true, header: true,
        complete: function(results) {
          allMarkers = results.data.map(place => {
            if (!place.lat || !place.lng) return null;
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(place.lat), lng: parseFloat(place.lng) }, map: map
            });
            marker.addListener("click", () => {
              currentStoreId = place.name;
              document.getElementById("storeName").textContent = place.name;
              document.getElementById("storeInfo").innerHTML =
                `${place.description || ''}<br>${place.link ? `<a href="${place.link}" target="_blank">â–¶ è©³ã—ãè¦‹ã‚‹</a>` : ''}`;
              document.getElementById("storeDetail").classList.add("active");
              loadComments(true);
            });
            marker.name = place.name;
            marker.description = place.description;
            return marker;
          }).filter(m => m !== null);
        }
      });

      document.getElementById("searchBox").addEventListener("input", function(e) {
        const keyword = e.target.value.toLowerCase();
        allMarkers.forEach(marker => {
          const name = marker.name.toLowerCase();
          const desc = (marker.description || '').toLowerCase();
          const match = name.includes(keyword) || desc.includes(keyword);
          marker.setVisible(match);
        });
      });
    }

    // è¯„è®ºåŠ è½½
    function loadComments(reset=false) {
      if (!currentStoreId) return;
      const commentsDiv = document.getElementById("comments");
      if (reset) { commentsDiv.innerHTML = ""; lastVisible = null; }

      let query = db.collection("comments")
        .where("storeId","==",currentStoreId)
        .orderBy("time","desc").limit(5);

      if (lastVisible) query = query.startAfter(lastVisible);

      query.get().then(snapshot => {
        if (!snapshot.empty) {
          lastVisible = snapshot.docs[snapshot.docs.length-1];
          snapshot.forEach(doc => {
            const data = doc.data();
            const stars = "â˜…".repeat(data.rating||0) + "â˜†".repeat(5-(data.rating||0));
            const commentEl = document.createElement("div");
            commentEl.classList.add("comment-item");
            commentEl.innerHTML =
              `<p><strong>${data.name}</strong> (${new Date(data.time?.toDate()).toLocaleString()})</p>
               <p>${stars}</p>
               <p>${data.text}</p>`;
            commentsDiv.appendChild(commentEl);
          });
          document.getElementById("loadMoreBtn").style.display = "block";
        } else {
          document.getElementById("loadMoreBtn").style.display = "none";
        }
      });
    }

    // æäº¤è¯„è®º
    document.getElementById("commentForm").addEventListener("submit", function(e){
      e.preventDefault();
      const name = document.getElementById("userName").value;
      const text = document.getElementById("userComment").value;
      const rating = parseInt(document.getElementById("rating").value) || 0;
      if (!currentStoreId) return;
      db.collection("comments").add({
        storeId: currentStoreId, name: name, text: text,
        rating: rating, time: new Date()
      }).then(()=>{
        alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
        document.getElementById("commentForm").reset();
        document.getElementById("rating").value = 0;
        loadComments(true);
      });
    });

    // æ˜Ÿçº§è¯„åˆ†é€‰æ‹©
    document.querySelectorAll(".star-rating span").forEach(star => {
      star.addEventListener("click", () => {
        document.getElementById("rating").value = star.dataset.value;
        document.querySelectorAll(".star-rating span").forEach(s=>s.classList.remove("active"));
        star.classList.add("active");
      });
    });

    document.getElementById("loadMoreBtn").addEventListener("click", ()=> loadComments(false));
    document.getElementById("closeDetail").addEventListener("click", ()=> document.getElementById("storeDetail").classList.remove("active"));
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDg-vCkfk4ys_m3oWLlCV0D-ZHcj4EtJ4g&callback=initMap"></script>
</body>
</html>
